<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="Openwrt + Clash 全局科学上网"><meta itemprop=description content="最近把 Newifi3 D2 的系统折腾安装上了 OpenWrt, 这篇文章记录我在 OpenWrt 上折腾 Clash 全局科学上网的过程。"><meta itemprop=datePublished content="2022-08-11T07:02:45+00:00"><meta itemprop=dateModified content="2022-08-11T07:02:45+00:00"><meta itemprop=wordCount content="2110"><meta itemprop=image content="https://razeencheng.com/android-chrome-192x192.png"><meta itemprop=keywords content="newifi3,homelib,科学上网,"><meta property="og:title" content="Openwrt + Clash 全局科学上网"><meta property="og:description" content="最近把 Newifi3 D2 的系统折腾安装上了 OpenWrt, 这篇文章记录我在 OpenWrt 上折腾 Clash 全局科学上网的过程。"><meta property="og:type" content="article"><meta property="og:url" content="https://razeencheng.com/posts/newifi3-d2-openwrt-clash/"><meta property="og:image" content="https://razeencheng.com/android-chrome-192x192.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-11T07:02:45+00:00"><meta property="article:modified_time" content="2022-08-11T07:02:45+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://razeencheng.com/android-chrome-192x192.png"><meta name=twitter:title content="Openwrt + Clash 全局科学上网"><meta name=twitter:description content="最近把 Newifi3 D2 的系统折腾安装上了 OpenWrt, 这篇文章记录我在 OpenWrt 上折腾 Clash 全局科学上网的过程。"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon href=/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=mask-icon href=/safari-pinned-tab.svg><link rel=manifest crossorigin=use-credentials href=/site.webmanifest><link rel="shortcut icon" href=/favicon.ico><title>Openwrt + Clash 全局科学上网</title><link rel=stylesheet href=https://razeencheng.com/css/style.min.a88782436067f84711b02510e9f09bd68bd49c25cd2e03624cd7320fa893b6ea.css integrity="sha256-qIeCQ2Bn+EcRsCUQ6fCb1ovUnCXNLgNiTNcyD6iTtuo=" crossorigin=anonymous></head><body id=page><header id=site-header><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://razeencheng.com>Razeen`s Blog</a></div><nav class="site-nav hide-in-mobile"><a href=https://razeencheng.com/posts/>文章</a>
<a href=https://razeencheng.com/tags/>标签</a>
<a href=https://razeencheng.com/categories/>分类</a>
<a href=https://razeencheng.com/about/>关于</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href=https://twitter.com/razeencheng target=_blank rel="noopener me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=https://github.com/razeencheng target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></span><button id=menu-btn class=hdr-btn title=菜单><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://razeencheng.com/posts/>文章</a></li><li><a href=https://razeencheng.com/tags/>标签</a></li><li><a href=https://razeencheng.com/categories/>分类</a></li><li><a href=https://razeencheng.com/about/>关于</a></li></ul></div><main class="site-main section-inner"><article class=thin><header class=post-header><div class=post-meta><span>Aug 11, 2022</span></div><h1>Openwrt + Clash 全局科学上网</h1></header><div class=content><p>最近把 Newifi3 D2 的系统折腾安装上了 OpenWrt, 这篇文章记录我在 OpenWrt 上折腾 Clash 全局科学上网的过程。</p><h2 id=科学上网思路>科学上网思路<a href=#科学上网思路 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>在折腾前，我们先想好怎么做。整体思路不外乎利用透明代理，代理海外流量，国内流量直连接。但其中还要解决一个 DNS 污染的问题。找了一些文章，看了一些视频，最后总结思路如下：</p><ol><li>利用 dnsmasq + 国内域名名单 将国内 DNS 解析直接走国内的 DNS 服务器，直接连接，实现加速访问；</li><li>不在国内域名名单的 DNS 解析走 dnscrypt-proxy2 进行解析，结合 iptables 将流量代理到 clash, clash 来判断是否直接连接还是经过代理服务器。</li></ol><p>下面是简单的时序图，只画了主要过程。</p><pre tabindex=0><code class=language-mermaid data-lang=mermaid>sequenceDiagram
    客户端-&gt;&gt;dnsmasq: 客户端 DNS 解析
    Note right of dnsmasq: 检查域名是否在国内名单中
    dnsmasq-&gt;&gt;dnsmasq: 国内的使用国内 DNS 解析 &lt;br/&gt; 并加入 ipset(chinalist)
    dnsmasq-&gt;&gt;dnscrypt-proxy2: 非国内名单中 &lt;br/&gt; 交给 dnscrypt-proxy2 解析
    dnscrypt-proxy2 -&gt;&gt; dnsmasq: 返回 IP
    dnsmasq-&gt;&gt;客户端: 返回 IP
    客户端-&gt;&gt;iptables: 客户端 tcp 请求到达 iptables
    iptables-&gt;&gt;iptables: 检查 ip 是否是否在国内名单（chinalist）中  &lt;br/&gt; 国内的直接通过
    iptables-&gt;&gt;clash: 不在国内名单的转发
</code></pre><p>其中我们用到了：</p><ul><li><a href=https://openwrt.org/packages/pkgdata/dnsmasq-full#packagednsmasq-full>dnsmasq-full</a>: 主要就是提供 DNS 和 DHCP 服务，可配置性强，上面我们国内名单就是配置在这里的，而且 DNS 解析后，利用 ipset 将 IP 更新到 chinalist 中；</li><li><a href=https://ipset.netfilter.org/>ipset</a>: 一个可以操作 IP 集合的工具，我们国内IP名单就是用它动态生成的；</li><li><a href=https://github.com/DNSCrypt/dnscrypt-proxy>dnscrypt-proxy2</a>: 一个强大的DNS代理工具，支持一些新的 DNS 协议， 如 <a href=https://dnscrypt.info/protocol/>DNSCrypt v2</a>, <a href=https://www.rfc-editor.org/rfc/rfc8484.txt>DNS-over-HTTPS</a>, <a href=https://github.com/DNSCrypt/dnscrypt-protocol/blob/master/ANONYMIZED-DNSCRYPT.txt>Anonymized DNSCrypt</a> 和 <a href=https://github.com/DNSCrypt/dnscrypt-resolvers/blob/master/v3/odoh-servers.md>ODoH (Oblivious DoH)</a>。 我们这里用它主要是防止海外域名的 DNS 污染；</li><li><a href=https://www.netfilter.org/projects/iptables/index.html>iptables</a>：linux 上强大的包处理包转发软件，我们用几条规则将国内的节点直连，其他节点走 clash。</li></ul><h2 id=准备梯子>准备梯子<a href=#准备梯子 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>要科学上网，你必须有一个梯子，可以自己弄个海外的服务器搭建一个，或者直接购买现场的服务。推荐购买现在的服务，节点多，不怕封==。 可以直接 Google, 有很多推荐的文章，自己比较下，选择合适的购买。给个参考，我买的这个<a href="https://portal.shadowsocks.nz/aff.php?aff=26059">shadowsocks</a> 50刀三年，90多节点，100G流量每月，我17年开始用的，还算比较稳定，除了一些特殊的时期。</p><h2 id=安装--配置-clash>安装 & 配置 Clash<a href=#安装--配置-clash class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><h3 id=下载安装>下载安装<a href=#下载安装 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>首先，我们要下载或者自己编译 clash。
直接<a href=https://github.com/Dreamacro/clash/releases>下载地址</a>。选择路由器对应的版本，Newifi3 D2 选择 <code>clash-linux-mipsle-softfloat</code> 版本。</p><p><img src=https://s.razeen.cn/images/2022/16601720028282.jpg alt></p><p>上传到路由器。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>scp clash-linux-mipsle-softfloat-v1.11.4.gz root@192.168.100.1:/tmp/
</span></span></code></pre></div><p>ssh 到路由器上解压，赋予执行权限。 路由器的 ssh 密码就是页面登录的密码。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh root@192.168.100.1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>gzip -d /tmp/clash-linux-mipsle-softfloat-v1.11.4.gz
</span></span><span class=line><span class=cl>mv /tmp/clash-linux-mipsle-softfloat-v1.11.4 /bin/clash
</span></span><span class=line><span class=cl>chmod +x /bin/clash
</span></span></code></pre></div><h3 id=配置>配置<a href=#配置 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>主要准备三个文件：</p><ul><li>配置文件 config.yaml</li></ul><p><a href=https://github.com/Dreamacro/clash/wiki/configuration#introduction>Github</a>上有完整的配置说明。我<a href=https://gist.github.com/razeencheng/554dc6c1592b5c831f53f9b8503b86d5>这里</a>给出我的配置参考。后面将用到下面两个端口。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># http proxy 端口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>7890</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 透明代理端口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>redir-port</span><span class=p>:</span><span class=w> </span><span class=m>7892</span><span class=w>
</span></span></span></code></pre></div><p>放到 /etc/clash/ 目录下。</p><ul><li>地理数据库 Country.mmdb [可选]</li></ul><p>启动的时候，如果没有这个库 Clash 也会自动去下载，如果你和我一样，从 Github 下载很慢，可以先下载好，上传上去。 这里是<a href=https://github.com/Dreamacro/maxmind-geoip/releases/latest/download/Country.mmdb>下载地址</a>。</p><p>Clash 依赖 <code>Country.mmdb</code> 数据来判断流量是直达还是走代理。</p><p>这个也放到 /etc/clash/ 目录下。</p><ul><li>service 脚本</li></ul><p>我希望 Clash 是以 service 运行的，方便管理。 写了一个服务脚本如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/sh /etc/rc.common
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=nv>START</span><span class=o>=</span><span class=m>90</span>
</span></span><span class=line><span class=cl><span class=nv>USE_PROCD</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>start_service<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        procd_open_instance
</span></span><span class=line><span class=cl>        procd_set_param <span class=nb>command</span> /bin/clash -d /etc/clash
</span></span><span class=line><span class=cl>        procd_set_param respawn <span class=m>300</span> <span class=m>0</span> <span class=m>5</span> <span class=c1># threshold, timeout, retry</span>
</span></span><span class=line><span class=cl>        procd_set_param file /etc/clash/config.yml
</span></span><span class=line><span class=cl>        procd_set_param stdout <span class=m>1</span>
</span></span><span class=line><span class=cl>        procd_set_param stderr <span class=m>1</span>
</span></span><span class=line><span class=cl>        procd_set_param pidfile /var/run/clash.pid
</span></span><span class=line><span class=cl>        procd_close_instance
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>这个放到 /etc/init.d/ 目录下。</p><h3 id=启动-clash>启动 Clash<a href=#启动-clash class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>配置文件和服务都放好位置后，我们就可以启动 Clash 了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>chmod +x /etc/init.d/clash
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 启动 并设置开机自启动</span>
</span></span><span class=line><span class=cl>service clash start
</span></span><span class=line><span class=cl>service clash <span class=nb>enable</span>
</span></span></code></pre></div><p>可以用 <code>logread</code> 查看日志, 看看是否正常启动。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>logread -e clash -f
</span></span></code></pre></div><p>这样 Clash 就配置好了，透明代理和HTTP代理都可以使用了。</p><h2 id=安装-dnsmasq-fulldnscrypt-proxy2>安装 dnsmasq-full、dnscrypt-proxy2<a href=#安装-dnsmasq-fulldnscrypt-proxy2 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>接下来我们需要 ssh 到路由器上操作了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 登陆路由器</span>
</span></span><span class=line><span class=cl>ssh root@192.168.1.1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># update 一下</span>
</span></span><span class=line><span class=cl>opkg update
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 卸载原来的 dnsmasq 安装 dnsmasq-full</span>
</span></span><span class=line><span class=cl>opkg remove dnsmasq <span class=o>&amp;&amp;</span> opkg install dnsmasq-full
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#  安装 dnscrypt-proxy2 和其他一些基础工具包</span>
</span></span><span class=line><span class=cl>opkg install curl ipset dnscrypt-proxy2 ca-certificates coreutils-base64
</span></span></code></pre></div><h3 id=配置-dnscrypt-proxy2>配置 dnscrypt-proxy2<a href=#配置-dnscrypt-proxy2 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vim /etc/dnscrypt-proxy2/dnscrypt-proxy.toml
</span></span></code></pre></div><p>基本上在原来的配置上修改一下就好了。 我这边主要修改了一下监听的地址，以及加了一个 HTTP 代理地址（clash http proxy 地址），因为其中部分配置是需要从 Github 下载的，我这访问 GitHub 不走代理有点抽疯。更多配置参考<a href=https://github.com/DNSCrypt/dnscrypt-proxy/wiki/Configuration>官方文档</a>。 我的配置如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=nx>listen_addresses</span> <span class=p>=</span> <span class=p>[</span><span class=s1>&#39;127.0.0.1:5353&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>max_clients</span> <span class=p>=</span> <span class=mi>250</span>
</span></span><span class=line><span class=cl><span class=nx>ipv4_servers</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=nx>ipv6_servers</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=nx>dnscrypt_servers</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=nx>doh_servers</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=nx>odoh_servers</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=nx>require_dnssec</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=nx>require_nolog</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=nx>require_nofilter</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=nx>disabled_server_names</span> <span class=p>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=nx>force_tcp</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=c># Clash HTTP  代理地址，加速配置下载</span>
</span></span><span class=line><span class=cl><span class=nx>http_proxy</span> <span class=p>=</span> <span class=s1>&#39;http://127.0.0.1:7890&#39;</span>
</span></span><span class=line><span class=cl><span class=nx>timeout</span> <span class=p>=</span> <span class=mi>5000</span>
</span></span><span class=line><span class=cl><span class=nx>keepalive</span> <span class=p>=</span> <span class=mi>30</span>
</span></span><span class=line><span class=cl><span class=nx>log_level</span> <span class=p>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=nx>cert_refresh_delay</span> <span class=p>=</span> <span class=mi>240</span>
</span></span><span class=line><span class=cl><span class=nx>bootstrap_resolvers</span> <span class=p>=</span> <span class=p>[</span><span class=s1>&#39;114.114.114.114:53&#39;</span><span class=p>,</span> <span class=s1>&#39;9.9.9.9:53&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>ignore_system_dns</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=nx>netprobe_timeout</span> <span class=p>=</span> <span class=mi>60</span>
</span></span><span class=line><span class=cl><span class=nx>netprobe_address</span> <span class=p>=</span> <span class=s1>&#39;9.9.9.9:53&#39;</span>
</span></span><span class=line><span class=cl><span class=nx>log_files_max_size</span> <span class=p>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=nx>log_files_max_age</span> <span class=p>=</span> <span class=mi>7</span>
</span></span><span class=line><span class=cl><span class=nx>block_ipv6</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=nx>block_unqualified</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=nx>block_undelegated</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=nx>reject_ttl</span> <span class=p>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=nx>cache</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=nx>cache_size</span> <span class=p>=</span> <span class=mi>512</span>
</span></span><span class=line><span class=cl><span class=nx>cache_min_ttl</span> <span class=p>=</span> <span class=mi>600</span>
</span></span><span class=line><span class=cl><span class=nx>cache_max_ttl</span> <span class=p>=</span> <span class=mi>86400</span>
</span></span><span class=line><span class=cl><span class=nx>cache_neg_min_ttl</span> <span class=p>=</span> <span class=mi>60</span>
</span></span><span class=line><span class=cl><span class=nx>cache_neg_max_ttl</span> <span class=p>=</span> <span class=mi>600</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>sources</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=p>[</span><span class=nx>sources</span><span class=p>.</span><span class=s1>&#39;public-resolvers&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>   <span class=nx>urls</span> <span class=p>=</span> <span class=p>[</span><span class=s1>&#39;https://raw.githubusercontent.com/DNSCrypt/dnscrypt-resolvers/master/v3/public-resolvers.md&#39;</span><span class=p>,</span> <span class=s1>&#39;https://download.dnscrypt.info/resolvers-list/v3/public-resolvers.md&#39;</span><span class=p>,</span> <span class=s1>&#39;https://ipv6.download.dnscrypt.info/resolvers-list/v3/public-resolvers.md&#39;</span><span class=p>,</span> <span class=s1>&#39;https://download.dnscrypt.net/resolvers-list/v3/public-resolvers.md&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>   <span class=nx>cache_file</span> <span class=p>=</span> <span class=s1>&#39;public-resolvers.md&#39;</span>
</span></span><span class=line><span class=cl>   <span class=nx>minisign_key</span> <span class=p>=</span> <span class=s1>&#39;RWQf6LRCGA9i53mlYecO4IzT51TGPpvWucNSCh1CBM0QTaLn73Y7GFO3&#39;</span>
</span></span><span class=line><span class=cl>   <span class=nx>refresh_delay</span> <span class=p>=</span> <span class=mi>72</span>
</span></span><span class=line><span class=cl>   <span class=nx>prefix</span> <span class=p>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=p>[</span><span class=nx>sources</span><span class=p>.</span><span class=s1>&#39;relays&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>   <span class=nx>urls</span> <span class=p>=</span> <span class=p>[</span><span class=s1>&#39;https://raw.githubusercontent.com/DNSCrypt/dnscrypt-resolvers/master/v3/relays.md&#39;</span><span class=p>,</span> <span class=s1>&#39;https://download.dnscrypt.info/resolvers-list/v3/relays.md&#39;</span><span class=p>,</span> <span class=s1>&#39;https://ipv6.download.dnscrypt.info/resolvers-list/v3/relays.md&#39;</span><span class=p>,</span> <span class=s1>&#39;https://download.dnscrypt.net/resolvers-list/v3/relays.md&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>   <span class=nx>cache_file</span> <span class=p>=</span> <span class=s1>&#39;relays.md&#39;</span>
</span></span><span class=line><span class=cl>   <span class=nx>minisign_key</span> <span class=p>=</span> <span class=s1>&#39;RWQf6LRCGA9i53mlYecO4IzT51TGPpvWucNSCh1CBM0QTaLn73Y7GFO3&#39;</span>
</span></span><span class=line><span class=cl>   <span class=nx>refresh_delay</span> <span class=p>=</span> <span class=mi>72</span>
</span></span><span class=line><span class=cl>   <span class=nx>prefix</span> <span class=p>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>fragments_blocked</span> <span class=p>=</span> <span class=p>[</span><span class=s1>&#39;cisco&#39;</span><span class=p>,</span> <span class=s1>&#39;cisco-ipv6&#39;</span><span class=p>,</span> <span class=s1>&#39;cisco-familyshield&#39;</span><span class=p>,</span> <span class=s1>&#39;cisco-familyshield-ipv6&#39;</span><span class=p>,</span> <span class=s1>&#39;cleanbrowsing-adult&#39;</span><span class=p>,</span> <span class=s1>&#39;cleanbrowsing-adult-ipv6&#39;</span><span class=p>,</span> <span class=s1>&#39;cleanbrowsing-family&#39;</span><span class=p>,</span> <span class=s1>&#39;cleanbrowsing-family-ipv6&#39;</span><span class=p>,</span> <span class=s1>&#39;cleanbrowsing-security&#39;</span><span class=p>,</span> <span class=s1>&#39;cleanbrowsing-security-ipv6&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>skip_incompatible</span> <span class=p>=</span> <span class=kc>false</span>
</span></span></code></pre></div><p>配置好后，把服务重启。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>#  重启</span>
</span></span><span class=line><span class=cl>service dnscrypt-proxy restart
</span></span><span class=line><span class=cl><span class=c1># 开机自启</span>
</span></span><span class=line><span class=cl>service dnscrypt-proxy <span class=nb>enable</span>
</span></span><span class=line><span class=cl><span class=c1># 查看日志</span>
</span></span><span class=line><span class=cl>logread -e dnscrypt-proxy -f
</span></span></code></pre></div><h3 id=配置-dnsmasq>配置 dnsmasq<a href=#配置-dnsmasq class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>配置 dnsmasq 的配置文件夹。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir /etc/dnsmasq.d
</span></span><span class=line><span class=cl>uci add_list dhcp.@dnsmasq<span class=o>[</span>0<span class=o>]</span>.confdir<span class=o>=</span>/etc/dnsmasq.d
</span></span><span class=line><span class=cl>uci add_list dhcp.@dnsmasq<span class=o>[</span>0<span class=o>]</span>.cachesize<span class=o>=</span><span class=m>10000</span>
</span></span><span class=line><span class=cl>uci commit dhcp
</span></span></code></pre></div><p>下载大陆白名单，让大陆的走指定的解析，直接连接，达到加速国内站点的目的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建一个放脚本的文件夹</span>
</span></span><span class=line><span class=cl>mkdir -p /etc/scripts <span class=o>&amp;&amp;</span> <span class=nb>cd</span> /etc/scripts
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 由于访问 Github 不是很通畅，使用 http 代理</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>https_proxy</span><span class=o>=</span>http://127.0.0.1:7890
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 下载大陆白名单，生成 dnsmasq 配置的脚本</span>
</span></span><span class=line><span class=cl>curl -L -o generate_dnsmasq_chinalist.sh https://github.com/cokebar/openwrt-scripts/raw/master/generate_dnsmasq_chinalist.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 赋权</span>
</span></span><span class=line><span class=cl>chmod +x generate_dnsmasq_chinalist.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 执行脚本，生成配置</span>
</span></span><span class=line><span class=cl>sh generate_dnsmasq_chinalist.sh -d 114.114.114.114 -p <span class=m>53</span> -s chinalist -o /etc/dnsmasq.d/accelerated-domains.china.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 重启 dnsmasq 使配置生效</span>
</span></span><span class=line><span class=cl>service dnsmasq restart
</span></span></code></pre></div><p>除了这些，我们还需要登录管理界面，设置 DNS 转发。</p><p>在 <code>Network > DHCP and DNS > General Settings</code> 中，将 DNS 转发到 dnsencrpt-proxy2, 如下图:</p><p><img src=https://s.razeen.cn/images/2022/16598842912751.jpg alt></p><p>同时，忽略解析文件。
<img src=https://s.razeen.cn/images/2022/16601687894908.jpg alt></p><p>保存并应用后，dnsmasq 就配置好了。</p><h2 id=配置-iptables>配置 iptables<a href=#配置-iptables class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>在 <code>Network > Firewall > Custom Rules</code> 中，添加以下规则并保存。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>iptables -t nat -N clash
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 本地白名单部分</span>
</span></span><span class=line><span class=cl>iptables -t nat -A clash -d 0.0.0.0/8 -j RETURN
</span></span><span class=line><span class=cl>iptables -t nat -A clash -d 10.0.0.0/8 -j RETURN
</span></span><span class=line><span class=cl>iptables -t nat -A clash -d 127.0.0.0/8 -j RETURN
</span></span><span class=line><span class=cl>iptables -t nat -A clash -d 169.254.0.0/16 -j RETURN
</span></span><span class=line><span class=cl>iptables -t nat -A clash -d 172.16.0.0/12 -j RETURN
</span></span><span class=line><span class=cl>iptables -t nat -A clash -d 192.168.0.0/16 -j RETURN
</span></span><span class=line><span class=cl>iptables -t nat -A clash -d 224.0.0.0/4 -j RETURN
</span></span><span class=line><span class=cl>iptables -t nat -A clash -d 240.0.0.0/4 -j RETURN
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 清空 ipset 集合</span>
</span></span><span class=line><span class=cl>ipset destroy
</span></span><span class=line><span class=cl>ipset create chinalist hash:net
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 国内白名单</span>
</span></span><span class=line><span class=cl>iptables -t nat -A clash -m <span class=nb>set</span> --match-set chinalist dst -j RETURN
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 其他流量走透明代理</span>
</span></span><span class=line><span class=cl>iptables -t nat -A clash -p tcp -j REDIRECT --to-ports <span class=m>7892</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>iptables -t nat -A PREROUTING -p tcp -j clash
</span></span></code></pre></div><p>重启防火墙立即生效。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>/etc/init.d/firewall restart
</span></span></code></pre></div><p>到这里，我们就全部配置完成了，可以愉快的上网了。</p><h2 id=看看效果>看看效果。<a href=#看看效果 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>简单来说，用 Youtube 看 4k 应该是没问题的。</p><p><img src=https://s.razeen.cn/images/2022/jietu20220811062347hd.gif alt=Jietu20220811-062347-HD></p><p><img src=https://s.razeen.cn/images/2022/16601720921476.jpg alt></p><p><strong>参考</strong></p><ul><li><a href=https://github.com/SeonMe/openwrt-trojan>openwrt-trojan</a></li><li><a href=https://github.com/Dreamacro/clash>clash</a></li></ul></div><div class="related-posts thin"><h2>相关推荐</h2><ul><li><a href=/posts/newifi3-d2-with-openwrt/>Newifi3 刷入 OpenWrt 固件 v21.02</a></li><li><a href=/posts/start-use-newifi3/>Newifi3 实现低成本家庭级科学上网</a></li><li><a href=/posts/homelib-008-gitlab-and-registry/>Homelib(8): 搭建自用 Gitlab 与 Docker 仓库</a></li><li><a href=/posts/nginx-tcp-stream-proxy-keep-real-client-ip/>Nginx Tcp 转发保留客户端真实 IP （PROXY Protocol）</a></li><li><a href=/posts/homelib-007-set-ipsec-vpn-client/>Homelib (7)：IPSec VPN（基于证书认证）客户端设置</a></li></ul></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://razeencheng.com/tags/newifi3>newifi3</a></span><span class=tag><a href=https://razeencheng.com/tags/homelib>homelib</a></span><span class=tag><a href=https://razeencheng.com/tags/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91>科学上网</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>2110 字</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2022-08-11 07:02 +0000</p></footer></article><aside id=toc class=show-toc><div class=toc-title>目录</div><nav id=TableOfContents><ul><li><a href=#科学上网思路>科学上网思路</a></li><li><a href=#准备梯子>准备梯子</a></li><li><a href=#安装--配置-clash>安装 & 配置 Clash</a><ul><li><a href=#下载安装>下载安装</a></li><li><a href=#配置>配置</a></li><li><a href=#启动-clash>启动 Clash</a></li></ul></li><li><a href=#安装-dnsmasq-fulldnscrypt-proxy2>安装 dnsmasq-full、dnscrypt-proxy2</a><ul><li><a href=#配置-dnscrypt-proxy2>配置 dnscrypt-proxy2</a></li><li><a href=#配置-dnsmasq>配置 dnsmasq</a></li></ul></li><li><a href=#配置-iptables>配置 iptables</a></li><li><a href=#看看效果>看看效果。</a></li></ul></nav></aside><div class="post-nav thin"><a class=next-post href=https://razeencheng.com/posts/nas-01-unboxing/><span class=post-nav-label><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>&nbsp;新</span><br><span>NAS折腾记(1)：328元的4盘位Nas机箱开箱</span></a>
<a class=prev-post href=https://razeencheng.com/posts/newifi3-d2-with-openwrt/><span class=post-nav-label>旧&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>Newifi3 刷入 OpenWrt 固件 v21.02</span></a></div><div id=google-ads class=thin><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4450478767591566" crossorigin=anonymous></script>
<ins class=adsbygoogle style=display:block data-ad-client=ca-pub-4450478767591566 data-ad-slot=8164928618 data-ad-format=auto data-full-width-responsive=true></ins>
<script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div id=comments class=thin><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//razeen-me.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></main><footer id=site-footer class="section-inner thin"><p>&copy; 2017 - 2022 <a href=https://razeencheng.com>Razeen</a> &#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://razeencheng.com/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://s.razeen.cn/assets/js/mermaid.min.js></script>
<script>Array.from(document.getElementsByClassName("language-mermaid")).forEach(e=>{e.parentElement.outerHTML=`<div class="mermaid">${e.innerText}</div>`})</script><script src=https://razeencheng.com/js/main.min.4e6345981f1ff315bbb7afa61eacf413923b536e5a4d5b22f698d96b624d48c4.js integrity="sha256-TmNFmB8f8xW7t6+mHqz0E5I7U25aTVsi9pjZa2JNSMQ=" crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4BKH11NSEY"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4BKH11NSEY")</script></body></html>