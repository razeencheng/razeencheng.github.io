<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="记一次 PostgreSQL LIKE 索引优化，联合字段 LIKE 查询优化。"><meta itemprop=description content="由于最近我司业务量上涨，数据量剧增，数据库查询速度明显变慢，单次查询居然达到1800ms以上，急需优化。待查阅一番后，我知道了LIKE查询正确的索引使用姿势，特别是一些符合字段索引。"><meta itemprop=datePublished content="2018-09-01T07:06:06+00:00"><meta itemprop=dateModified content="2018-09-01T07:06:06+00:00"><meta itemprop=wordCount content="1815"><meta itemprop=image content="https://razeencheng.com/android-chrome-192x192.png"><meta itemprop=keywords content="postgres,like,index,"><meta property="og:title" content="记一次 PostgreSQL LIKE 索引优化，联合字段 LIKE 查询优化。"><meta property="og:description" content="由于最近我司业务量上涨，数据量剧增，数据库查询速度明显变慢，单次查询居然达到1800ms以上，急需优化。待查阅一番后，我知道了LIKE查询正确的索引使用姿势，特别是一些符合字段索引。"><meta property="og:type" content="article"><meta property="og:url" content="https://razeencheng.com/posts/pg-like-index-optimize/"><meta property="og:image" content="https://razeencheng.com/android-chrome-192x192.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-09-01T07:06:06+00:00"><meta property="article:modified_time" content="2018-09-01T07:06:06+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://razeencheng.com/android-chrome-192x192.png"><meta name=twitter:title content="记一次 PostgreSQL LIKE 索引优化，联合字段 LIKE 查询优化。"><meta name=twitter:description content="由于最近我司业务量上涨，数据量剧增，数据库查询速度明显变慢，单次查询居然达到1800ms以上，急需优化。待查阅一番后，我知道了LIKE查询正确的索引使用姿势，特别是一些符合字段索引。"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon href=/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=mask-icon href=/safari-pinned-tab.svg><link rel=manifest crossorigin=use-credentials href=/site.webmanifest><link rel="shortcut icon" href=/favicon.ico><title>记一次 PostgreSQL LIKE 索引优化，联合字段 LIKE 查询优化。</title><link rel=stylesheet href=https://razeencheng.com/css/style.min.a88782436067f84711b02510e9f09bd68bd49c25cd2e03624cd7320fa893b6ea.css integrity="sha256-qIeCQ2Bn+EcRsCUQ6fCb1ovUnCXNLgNiTNcyD6iTtuo=" crossorigin=anonymous></head><body id=page><header id=site-header><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://razeencheng.com>Razeen`s Blog</a></div><nav class="site-nav hide-in-mobile"><a href=https://razeencheng.com/posts/>文章</a>
<a href=https://razeencheng.com/tags/>标签</a>
<a href=https://razeencheng.com/categories/>分类</a>
<a href=https://razeencheng.com/about/>关于</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href=https://twitter.com/razeencheng target=_blank rel="noopener me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=https://github.com/razeencheng target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></span><button id=menu-btn class=hdr-btn title=菜单><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://razeencheng.com/posts/>文章</a></li><li><a href=https://razeencheng.com/tags/>标签</a></li><li><a href=https://razeencheng.com/categories/>分类</a></li><li><a href=https://razeencheng.com/about/>关于</a></li></ul></div><main class="site-main section-inner"><article class=thin><header class=post-header><div class=post-meta><span>Sep 1, 2018</span></div><h1>记一次 PostgreSQL LIKE 索引优化，联合字段 LIKE 查询优化。</h1></header><div class=content><p>由于最近我司业务量上涨，数据量剧增，数据库查询速度明显变慢，单次查询居然达到1800ms以上，急需优化。待查阅一番后，我知道了LIKE查询正确的索引使用姿势，特别是一些符合字段索引。</p><p>模糊查询的使用场景实在太多了，正确使用索引实在是太重要了。或许一个关键的优化就能为你节省更多的资源，带来更好的用户体验。</p><p>少啰嗦，我们看实例。</p><p><em>由于未经我司同意，数据不能用真实了，下面数据是我盗来的😢</em></p><p>首先，我们这里有一张存了一百万条信息的<code>users</code>表。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=w>                                    </span><span class=k>Table</span><span class=w> </span><span class=s2>&#34;public.users&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Column</span><span class=w>      </span><span class=o>|</span><span class=w>            </span><span class=k>Type</span><span class=w>             </span><span class=o>|</span><span class=w>                     </span><span class=n>Modifiers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------------+-----------------------------+----------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=n>id</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=nb>integer</span><span class=w>                     </span><span class=o>|</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=n>nextval</span><span class=p>(</span><span class=s1>&#39;users_id_seq&#39;</span><span class=p>::</span><span class=n>regclass</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>username</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=nb>character</span><span class=w> </span><span class=nb>varying</span><span class=w>           </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>first_name</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nb>character</span><span class=w> </span><span class=nb>varying</span><span class=w>           </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>last_name</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=nb>character</span><span class=w> </span><span class=nb>varying</span><span class=w>           </span><span class=o>|</span><span class=w>
</span></span></span></code></pre></div><h3 id=普通查询>普通查询<a href=#普通查询 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>在不添加任何索引的情况下，我们查询一次。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=o>&gt;</span><span class=w> </span><span class=k>EXPLAIN</span><span class=w> </span><span class=k>ANALYSE</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>username</span><span class=w> </span><span class=k>ILIKE</span><span class=w> </span><span class=s1>&#39;%foo%&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                  </span><span class=n>QUERY</span><span class=w> </span><span class=n>PLAN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>--------------------------------------------------------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=k>Aggregate</span><span class=w>  </span><span class=p>(</span><span class=n>cost</span><span class=o>=</span><span class=mi>21927</span><span class=p>.</span><span class=mi>24</span><span class=p>..</span><span class=mi>21927</span><span class=p>.</span><span class=mi>25</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>width</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>actual</span><span class=w> </span><span class=n>time</span><span class=o>=</span><span class=mi>737</span><span class=p>.</span><span class=mi>523</span><span class=p>..</span><span class=mi>737</span><span class=p>.</span><span class=mi>523</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>loops</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>-&gt;</span><span class=w>  </span><span class=n>Seq</span><span class=w> </span><span class=n>Scan</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>users</span><span class=w>  </span><span class=p>(</span><span class=n>cost</span><span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=p>..</span><span class=mi>21927</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>96</span><span class=w> </span><span class=n>width</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>actual</span><span class=w> </span><span class=n>time</span><span class=o>=</span><span class=mi>737</span><span class=p>.</span><span class=mi>520</span><span class=p>..</span><span class=mi>737</span><span class=p>.</span><span class=mi>520</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>0</span><span class=w> </span><span class=n>loops</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>Filter</span><span class=p>:</span><span class=w> </span><span class=p>((</span><span class=n>username</span><span class=p>)::</span><span class=nb>text</span><span class=w> </span><span class=o>~~*</span><span class=w> </span><span class=s1>&#39;%foo%&#39;</span><span class=p>::</span><span class=nb>text</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>Rows</span><span class=w> </span><span class=n>Removed</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>Filter</span><span class=p>:</span><span class=w> </span><span class=mi>1000000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Planning</span><span class=w> </span><span class=n>time</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>373</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Execution</span><span class=w> </span><span class=n>time</span><span class=p>:</span><span class=w> </span><span class=mi>737</span><span class=p>.</span><span class=mi>593</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>6</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>738</span><span class=p>.</span><span class=mi>404</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span></code></pre></div><p>结果，如大家所想一样，顺序扫描，很慢。</p><h3 id=btree-索引>btree 索引<a href=#btree-索引 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>很多童鞋会想到，那就加个索引呗。我们知道，pg里面一般默认都是btree索引，我们加一个试试。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>&gt;</span><span class=w> </span><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_users_username</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=p>(</span><span class=n>username</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>15987</span><span class=p>.</span><span class=mi>751</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span></code></pre></div><p>查询一下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=o>&gt;</span><span class=w> </span><span class=k>EXPLAIN</span><span class=w> </span><span class=k>ANALYSE</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>username</span><span class=w> </span><span class=k>ILIKE</span><span class=w> </span><span class=s1>&#39;%foo%&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                  </span><span class=n>QUERY</span><span class=w> </span><span class=n>PLAN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>--------------------------------------------------------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=k>Aggregate</span><span class=w>  </span><span class=p>(</span><span class=n>cost</span><span class=o>=</span><span class=mi>21927</span><span class=p>.</span><span class=mi>24</span><span class=p>..</span><span class=mi>21927</span><span class=p>.</span><span class=mi>25</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>width</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>actual</span><span class=w> </span><span class=n>time</span><span class=o>=</span><span class=mi>752</span><span class=p>.</span><span class=mi>271</span><span class=p>..</span><span class=mi>752</span><span class=p>.</span><span class=mi>271</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>loops</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>-&gt;</span><span class=w>  </span><span class=n>Seq</span><span class=w> </span><span class=n>Scan</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>users</span><span class=w>  </span><span class=p>(</span><span class=n>cost</span><span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=p>..</span><span class=mi>21927</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>96</span><span class=w> </span><span class=n>width</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>actual</span><span class=w> </span><span class=n>time</span><span class=o>=</span><span class=mi>752</span><span class=p>.</span><span class=mi>268</span><span class=p>..</span><span class=mi>752</span><span class=p>.</span><span class=mi>268</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>0</span><span class=w> </span><span class=n>loops</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>Filter</span><span class=p>:</span><span class=w> </span><span class=p>((</span><span class=n>username</span><span class=p>)::</span><span class=nb>text</span><span class=w> </span><span class=o>~~*</span><span class=w> </span><span class=s1>&#39;%foo%&#39;</span><span class=p>::</span><span class=nb>text</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>Rows</span><span class=w> </span><span class=n>Removed</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>Filter</span><span class=p>:</span><span class=w> </span><span class=mi>1000000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Planning</span><span class=w> </span><span class=n>time</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>599</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Execution</span><span class=w> </span><span class=n>time</span><span class=p>:</span><span class=w> </span><span class=mi>752</span><span class=p>.</span><span class=mi>318</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>6</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>753</span><span class=p>.</span><span class=mi>251</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span></code></pre></div><p>emm, 好家伙，居然还是顺序扫描。 这是由于一般的索引只能优化 <code>LIKE foo%</code>这类的向后的模糊查询。所以btree索引这里也达不到优化的效果。</p><h3 id=gin-索引--pg_trgm-模块>gin 索引 & pg_trgm 模块<a href=#gin-索引--pg_trgm-模块 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><blockquote><p>pg_trgm模块提供函数和操作符测定字母，数字，文本基于三元模型匹配的相似性， 还有支持快速搜索相似字符串的索引操作符类。</p></blockquote><blockquote><p>这里提到了一个三元模型，可能有童鞋不理解，其实很简单。打个比方<code>foo</code>的三元模型的集合为<code>{" f"," fo","foo","oo "}</code>, <code>foo|bar</code>的三元模型的集合为<code>{" f"," fo","foo","oo "," b"," ba","bar","ar "}</code>。也就是说将字符串拆解成三个字符一组，每个字符串被认为有两个空格前缀和一个空格后缀。</p></blockquote><p>Postgres使用trigram将字符串分解成更小的单元便于有效地索引它们。pg_trgm模块支持GIST或GIN索引，从9.1开始，这些索引支持LIKE/ILIKE查询。</p><p>要使用pg_trgm模块，首先要启用该扩展，然后使用<code>gin_trgm_ops</code>创建索引。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=o>&gt;</span><span class=w> </span><span class=k>CREATE</span><span class=w> </span><span class=n>EXTENSION</span><span class=w> </span><span class=n>pg_trgm</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>42</span><span class=p>.</span><span class=mi>206</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&gt;</span><span class=w> </span><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>trgm_idx_users_username</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>USING</span><span class=w> </span><span class=n>gin</span><span class=w> </span><span class=p>(</span><span class=n>username</span><span class=w> </span><span class=n>gin_trgm_ops</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>7082</span><span class=p>.</span><span class=mi>474</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span></code></pre></div><p>我们再次分析查询</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=o>&gt;</span><span class=w> </span><span class=k>EXPLAIN</span><span class=w> </span><span class=k>ANALYSE</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>username</span><span class=w> </span><span class=k>ILIKE</span><span class=w> </span><span class=s1>&#39;%foo%&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                               </span><span class=n>QUERY</span><span class=w> </span><span class=n>PLAN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>----------------------------------------------------------------------------------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=k>Aggregate</span><span class=w>  </span><span class=p>(</span><span class=n>cost</span><span class=o>=</span><span class=mi>369</span><span class=p>.</span><span class=mi>12</span><span class=p>..</span><span class=mi>369</span><span class=p>.</span><span class=mi>13</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>width</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>actual</span><span class=w> </span><span class=n>time</span><span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>030</span><span class=p>..</span><span class=mi>0</span><span class=p>.</span><span class=mi>030</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>loops</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>-&gt;</span><span class=w>  </span><span class=n>Bitmap</span><span class=w> </span><span class=n>Heap</span><span class=w> </span><span class=n>Scan</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>users</span><span class=w>  </span><span class=p>(</span><span class=n>cost</span><span class=o>=</span><span class=mi>12</span><span class=p>.</span><span class=mi>75</span><span class=p>..</span><span class=mi>368</span><span class=p>.</span><span class=mi>88</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>96</span><span class=w> </span><span class=n>width</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>actual</span><span class=w> </span><span class=n>time</span><span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>026</span><span class=p>..</span><span class=mi>0</span><span class=p>.</span><span class=mi>026</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>0</span><span class=w> </span><span class=n>loops</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>Recheck</span><span class=w> </span><span class=n>Cond</span><span class=p>:</span><span class=w> </span><span class=p>((</span><span class=n>username</span><span class=p>)::</span><span class=nb>text</span><span class=w> </span><span class=o>~~*</span><span class=w> </span><span class=s1>&#39;%foo%&#39;</span><span class=p>::</span><span class=nb>text</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=o>-&gt;</span><span class=w>  </span><span class=n>Bitmap</span><span class=w> </span><span class=k>Index</span><span class=w> </span><span class=n>Scan</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>trgm_idx_users_username</span><span class=w>  </span><span class=p>(</span><span class=n>cost</span><span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=p>..</span><span class=mi>12</span><span class=p>.</span><span class=mi>72</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>96</span><span class=w> </span><span class=n>width</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>actual</span><span class=w> </span><span class=n>time</span><span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>024</span><span class=p>..</span><span class=mi>0</span><span class=p>.</span><span class=mi>024</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>0</span><span class=w> </span><span class=n>loops</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=k>Index</span><span class=w> </span><span class=n>Cond</span><span class=p>:</span><span class=w> </span><span class=p>((</span><span class=n>username</span><span class=p>)::</span><span class=nb>text</span><span class=w> </span><span class=o>~~*</span><span class=w> </span><span class=s1>&#39;%foo%&#39;</span><span class=p>::</span><span class=nb>text</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Planning</span><span class=w> </span><span class=n>time</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>636</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Execution</span><span class=w> </span><span class=n>time</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>095</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>7</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=p>.</span><span class=mi>333</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span></code></pre></div><p>哇，2.33ms!!!</p><p>从查询过程上看，索引已经起作用了。这将我们的查询直接提高了两个数量级，作用很大。我在我司使用该索引后，查询从1800ms提升到了10ms左右,也算是效果惊人了。</p><blockquote><p>这里出现了个"Bitmap Heap Scan",这是什么呢？
pg里面常见到的对表扫描的计划有这四种：</p><ul><li>Seq Scan</li><li>Index Scan</li><li>Bitmap Heap Scan</li><li>Index Only Scan</li></ul><p>前面两个你也许一看就懂。
第一个无非是按照表的记录顺序从头到尾依次检索扫描，全表扫描，代价大；
第二个先扫描索引，从索引找到数据位置，再准备获取数据，索引扫描，快，I/O少；
第三个一次性将满足条件的索引项全部取出，并在内存中进行排序, 然后根据取出的索引项访问表数据。一般需要合并索引访问的结果子集时会用到这种方式。
第四个就是查询的字段直接就在索引中了，直接扫描索引即可。</p></blockquote><h3 id=联合字段like查询>联合字段LIKE查询<a href=#联合字段like查询 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>有时候，我们可能需要联合多个字段来查询数据。如，我们需要搜索一位可能叫<code>John Do</code>的人,这时候就需要我们将<code>first_name</code>与<code>last_name</code>联合作为条件查询了。</p><p>一般我们首先想到的是，在<code>first_name</code>与<code>last_name</code>都加上索引。那么可行么？我们先试一下。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=o>&gt;</span><span class=w> </span><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>trgm_idx_users_first</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>USING</span><span class=w> </span><span class=n>gin</span><span class=w> </span><span class=p>(</span><span class=n>first_name</span><span class=w> </span><span class=n>gin_trgm_ops</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>4577</span><span class=p>.</span><span class=mi>637</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&gt;</span><span class=w> </span><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>trgm_idx_users_last</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>USING</span><span class=w> </span><span class=n>gin</span><span class=w> </span><span class=p>(</span><span class=n>last_name</span><span class=w> </span><span class=n>gin_trgm_ops</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>4770</span><span class=p>.</span><span class=mi>507</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span></code></pre></div><p>查询</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=o>&gt;</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>first_name</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s1>&#39; &#39;</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>last_name</span><span class=w> </span><span class=k>ILIKE</span><span class=w> </span><span class=s1>&#39;%foo%&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                    </span><span class=n>QUERY</span><span class=w> </span><span class=n>PLAN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-------------------------------------------------------------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=k>Aggregate</span><span class=w>  </span><span class=p>(</span><span class=n>cost</span><span class=o>=</span><span class=mi>27027</span><span class=p>.</span><span class=mi>00</span><span class=p>..</span><span class=mi>27027</span><span class=p>.</span><span class=mi>01</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>width</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>actual</span><span class=w> </span><span class=n>time</span><span class=o>=</span><span class=mi>1025</span><span class=p>.</span><span class=mi>543</span><span class=p>..</span><span class=mi>1025</span><span class=p>.</span><span class=mi>544</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>loops</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>-&gt;</span><span class=w>  </span><span class=n>Seq</span><span class=w> </span><span class=n>Scan</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>users</span><span class=w>  </span><span class=p>(</span><span class=n>cost</span><span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=p>..</span><span class=mi>26927</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>40000</span><span class=w> </span><span class=n>width</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>actual</span><span class=w> </span><span class=n>time</span><span class=o>=</span><span class=mi>1025</span><span class=p>.</span><span class=mi>539</span><span class=p>..</span><span class=mi>1025</span><span class=p>.</span><span class=mi>539</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>0</span><span class=w> </span><span class=n>loops</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>Filter</span><span class=p>:</span><span class=w> </span><span class=p>((((</span><span class=n>first_name</span><span class=p>)::</span><span class=nb>text</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s1>&#39; &#39;</span><span class=p>::</span><span class=nb>text</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>last_name</span><span class=p>)::</span><span class=nb>text</span><span class=p>)</span><span class=w> </span><span class=o>~~*</span><span class=w> </span><span class=s1>&#39;%foo%&#39;</span><span class=p>::</span><span class=nb>text</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>Rows</span><span class=w> </span><span class=n>Removed</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>Filter</span><span class=p>:</span><span class=w> </span><span class=mi>1000000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Planning</span><span class=w> </span><span class=n>time</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>273</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Execution</span><span class=w> </span><span class=n>time</span><span class=p>:</span><span class=w> </span><span class=mi>1025</span><span class=p>.</span><span class=mi>591</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>6</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>1027</span><span class=p>.</span><span class=mi>547</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span></code></pre></div><p>看来还是没有用到索引，由于查询的时候使用的是联合的字段，单独的索引并不起作用。那么我们可以考虑将字段联合起来，添加一个索引。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>index_users_full_name</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>using</span><span class=w> </span><span class=n>gin</span><span class=w> </span><span class=p>((</span><span class=n>first_name</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s1>&#39; &#39;</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>last_name</span><span class=p>)</span><span class=w> </span><span class=n>gin_trgm_ops</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>我们再次尝试查询。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&gt;</span><span class=w> </span><span class=k>EXPLAIN</span><span class=w> </span><span class=k>ANALYSE</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>first_name</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s1>&#39; &#39;</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>last_name</span><span class=w> </span><span class=k>ILIKE</span><span class=w> </span><span class=s1>&#39;%foo%&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                                </span><span class=n>QUERY</span><span class=w> </span><span class=n>PLAN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------------------------------------------------------------------------------------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=k>Aggregate</span><span class=w>  </span><span class=p>(</span><span class=n>cost</span><span class=o>=</span><span class=mi>10605</span><span class=p>.</span><span class=mi>00</span><span class=p>..</span><span class=mi>10605</span><span class=p>.</span><span class=mi>01</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>width</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>actual</span><span class=w> </span><span class=n>time</span><span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>020</span><span class=p>..</span><span class=mi>0</span><span class=p>.</span><span class=mi>020</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>loops</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>-&gt;</span><span class=w>  </span><span class=n>Bitmap</span><span class=w> </span><span class=n>Heap</span><span class=w> </span><span class=n>Scan</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>users</span><span class=w>  </span><span class=p>(</span><span class=n>cost</span><span class=o>=</span><span class=mi>378</span><span class=p>.</span><span class=mi>01</span><span class=p>..</span><span class=mi>10505</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>40000</span><span class=w> </span><span class=n>width</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>actual</span><span class=w> </span><span class=n>time</span><span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>018</span><span class=p>..</span><span class=mi>0</span><span class=p>.</span><span class=mi>018</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>0</span><span class=w> </span><span class=n>loops</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>Recheck</span><span class=w> </span><span class=n>Cond</span><span class=p>:</span><span class=w> </span><span class=p>((((</span><span class=n>first_name</span><span class=p>)::</span><span class=nb>text</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s1>&#39; &#39;</span><span class=p>::</span><span class=nb>text</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>last_name</span><span class=p>)::</span><span class=nb>text</span><span class=p>)</span><span class=w> </span><span class=o>~~*</span><span class=w> </span><span class=s1>&#39;%foo%&#39;</span><span class=p>::</span><span class=nb>text</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=o>-&gt;</span><span class=w>  </span><span class=n>Bitmap</span><span class=w> </span><span class=k>Index</span><span class=w> </span><span class=n>Scan</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>index_users_full_name</span><span class=w>  </span><span class=p>(</span><span class=n>cost</span><span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=p>..</span><span class=mi>368</span><span class=p>.</span><span class=mi>01</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>40000</span><span class=w> </span><span class=n>width</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>actual</span><span class=w> </span><span class=n>time</span><span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>016</span><span class=p>..</span><span class=mi>0</span><span class=p>.</span><span class=mi>016</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>0</span><span class=w> </span><span class=n>loops</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=k>Index</span><span class=w> </span><span class=n>Cond</span><span class=p>:</span><span class=w> </span><span class=p>((((</span><span class=n>first_name</span><span class=p>)::</span><span class=nb>text</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s1>&#39; &#39;</span><span class=p>::</span><span class=nb>text</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>last_name</span><span class=p>)::</span><span class=nb>text</span><span class=p>)</span><span class=w> </span><span class=o>~~*</span><span class=w> </span><span class=s1>&#39;%foo%&#39;</span><span class=p>::</span><span class=nb>text</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Planning</span><span class=w> </span><span class=n>time</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>338</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Execution</span><span class=w> </span><span class=n>time</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>080</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>7</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>975</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span></code></pre></div><p>喔😯，相当的快。使用了<code> Bitmap Index</code>扫描的，看来索引很有效。</p><h3 id=最后>最后<a href=#最后 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>勇敢上文，我们一起了解了一下pg里利用<code>pg_trgm</code>模块来建立索引优化模糊查询。其实pg里买还有更多好用实用的功能，期待与大家一起探索～。</p><p><strong>本文参考</strong></p><ul><li><p><a href=https://niallburkley.com/blog/index-columns-for-like-in-postgres/>Index Columns for LIKE in PostgreSQL</a>.</p></li><li><p><a href=http://www.postgres.cn/docs/10/pgtrgm.html>pg_trgm</a></p></li></ul></div><div class="related-posts thin"><h2>相关推荐</h2><ul><li><a href=/posts/postgres-daily/>日常 Postgres 数据库点滴记录</a></li><li><a href=/posts/daily-pg-tips/>Go学习笔记(一) | postgres与golang点点滴滴</a></li></ul></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://razeencheng.com/tags/postgres>postgres</a></span><span class=tag><a href=https://razeencheng.com/tags/like>like</a></span><span class=tag><a href=https://razeencheng.com/tags/index>index</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>1815 字</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2018-09-01 07:06 +0000</p></footer></article><aside id=toc class=show-toc><div class=toc-title>目录</div><nav id=TableOfContents><ul><li><ul><li><a href=#普通查询>普通查询</a></li><li><a href=#btree-索引>btree 索引</a></li><li><a href=#gin-索引--pg_trgm-模块>gin 索引 & pg_trgm 模块</a></li><li><a href=#联合字段like查询>联合字段LIKE查询</a></li><li><a href=#最后>最后</a></li></ul></li></ul></nav></aside><div class="post-nav thin"><a class=next-post href=https://razeencheng.com/posts/start-ipfs-gateway/><span class=post-nav-label><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>&nbsp;新</span><br><span>IPFS 初体验，利用 IPFS 托管你的静态网站</span></a>
<a class=prev-post href=https://razeencheng.com/posts/disqus-reactions/><span class=post-nav-label>旧&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>Disqus 添加有趣的 Reactions 的功能</span></a></div><div id=google-ads class=thin><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4450478767591566" crossorigin=anonymous></script>
<ins class=adsbygoogle style=display:block data-ad-client=ca-pub-4450478767591566 data-ad-slot=8164928618 data-ad-format=auto data-full-width-responsive=true></ins>
<script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div id=comments class=thin><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//razeen-me.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></main><footer id=site-footer class="section-inner thin"><p>&copy; 2017 - 2022 <a href=https://razeencheng.com>Razeen</a> &#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://razeencheng.com/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://s.razeen.cn/assets/js/mermaid.min.js></script>
<script>Array.from(document.getElementsByClassName("language-mermaid")).forEach(e=>{e.parentElement.outerHTML=`<div class="mermaid">${e.innerText}</div>`})</script><script src=https://razeencheng.com/js/main.min.4e6345981f1ff315bbb7afa61eacf413923b536e5a4d5b22f698d96b624d48c4.js integrity="sha256-TmNFmB8f8xW7t6+mHqz0E5I7U25aTVsi9pjZa2JNSMQ=" crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4BKH11NSEY"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4BKH11NSEY")</script></body></html>