<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="TLS1.3正式更新，为Nginx添加TLS1.3的支持"><meta itemprop=description content="关于TLS1.3
在OpenSSL的github开源项目中我们可以看到最新的tag为OpenSSL_1_1_1,该版本为TLS1.3正式版。

更新：2018/09/12 昨天前OpenSSL_1_1_1发布了，已更新。


更多TLS v1.3内容看这里


nginx 更新到v1.15.8

从OpenSSL的博客中，我们知道TLS1.3与1TLS1.2的主要差异有以下几点："><meta itemprop=datePublished content="2018-04-16T02:18:57+00:00"><meta itemprop=dateModified content="2018-04-16T02:18:57+00:00"><meta itemprop=wordCount content="1920"><meta itemprop=image content="https://razeencheng.com/android-chrome-192x192.png"><meta itemprop=keywords content="tls1.3,nginx,"><meta property="og:title" content="TLS1.3正式更新，为Nginx添加TLS1.3的支持"><meta property="og:description" content="关于TLS1.3
在OpenSSL的github开源项目中我们可以看到最新的tag为OpenSSL_1_1_1,该版本为TLS1.3正式版。

更新：2018/09/12 昨天前OpenSSL_1_1_1发布了，已更新。


更多TLS v1.3内容看这里


nginx 更新到v1.15.8

从OpenSSL的博客中，我们知道TLS1.3与1TLS1.2的主要差异有以下几点："><meta property="og:type" content="article"><meta property="og:url" content="https://razeencheng.com/posts/nginx-tls1.3-draft26/"><meta property="og:image" content="https://razeencheng.com/android-chrome-192x192.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-04-16T02:18:57+00:00"><meta property="article:modified_time" content="2018-04-16T02:18:57+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://razeencheng.com/android-chrome-192x192.png"><meta name=twitter:title content="TLS1.3正式更新，为Nginx添加TLS1.3的支持"><meta name=twitter:description content="关于TLS1.3
在OpenSSL的github开源项目中我们可以看到最新的tag为OpenSSL_1_1_1,该版本为TLS1.3正式版。

更新：2018/09/12 昨天前OpenSSL_1_1_1发布了，已更新。


更多TLS v1.3内容看这里


nginx 更新到v1.15.8

从OpenSSL的博客中，我们知道TLS1.3与1TLS1.2的主要差异有以下几点："><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon href=/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=mask-icon href=/safari-pinned-tab.svg><link rel=manifest crossorigin=use-credentials href=/site.webmanifest><link rel="shortcut icon" href=/favicon.ico><title>TLS1.3正式更新，为Nginx添加TLS1.3的支持</title><link rel=stylesheet href=https://razeencheng.com/css/style.min.a88782436067f84711b02510e9f09bd68bd49c25cd2e03624cd7320fa893b6ea.css integrity="sha256-qIeCQ2Bn+EcRsCUQ6fCb1ovUnCXNLgNiTNcyD6iTtuo=" crossorigin=anonymous></head><body id=page><header id=site-header><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://razeencheng.com>Razeen`s Blog</a></div><nav class="site-nav hide-in-mobile"><a href=https://razeencheng.com/posts/>文章</a>
<a href=https://razeencheng.com/tags/>标签</a>
<a href=https://razeencheng.com/categories/>分类</a>
<a href=https://razeencheng.com/about/>关于</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href=https://twitter.com/razeencheng target=_blank rel="noopener me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=https://github.com/razeencheng target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></span><button id=menu-btn class=hdr-btn title=菜单><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://razeencheng.com/posts/>文章</a></li><li><a href=https://razeencheng.com/tags/>标签</a></li><li><a href=https://razeencheng.com/categories/>分类</a></li><li><a href=https://razeencheng.com/about/>关于</a></li></ul></div><main class="site-main section-inner"><article class=thin><header class=post-header><div class=post-meta><span>Apr 16, 2018</span></div><h1>TLS1.3正式更新，为Nginx添加TLS1.3的支持</h1></header><div class=content><h3 id=关于tls13>关于TLS1.3<a href=#关于tls13 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>在<a href=https://github.com/openssl/openssl/tree/OpenSSL_1_1_1>OpenSSL的github开源项目</a>中我们可以看到最新的tag为<code>OpenSSL_1_1_1</code>,该版本为<a href=https://github.com/openssl/openssl/blob/OpenSSL_1_1_1/include/openssl/tls1.h#L30>TLS1.3正式版</a>。</p><blockquote><p>更新：2018/09/12 昨天前OpenSSL_1_1_1发布了，已更新。</p></blockquote><blockquote><p>更多TLS v1.3内容看<a href=https://razeen.me/post/detail-of-tls13.html>这里</a></p></blockquote><blockquote><p>nginx 更新到v1.15.8</p></blockquote><p>从<a href=https://www.openssl.org/blog/blog/2017/05/04/tlsv1.3/>OpenSSL的博客</a>中，我们知道TLS1.3与1TLS1.2的主要差异有以下几点：</p><ul><li>有新的套件，旧的套件无法用在1.3连接中；</li><li>套件的定义与以往不一样，新的套件不指定证书类型(eg:RSA,DSA,ECDSA)以及秘钥交换机制(eg:DHE,ECDHE) ;</li><li>客户在<code>ClientHello</code>中提供<code>key_share</code>。这对<code>group</code>配置有影响;（这个group是什么，我还没去研究）</li><li>会话直到主要握手完成后才建立;</li><li>不支持重协商;</li><li>更多的握手被加密;</li><li>更多类型的消息可以扩展;</li><li>弃用DSA证书。（DSA貌似现在也没怎么见）</li></ul><h3 id=编译nginx>编译Nginx<a href=#编译nginx class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p><em>我的服务器：CentOS 7.4 64位</em></p><p>其实编译nginx很多人都写过，我这里主要参考<a href=https://imququ.com/post/my-nginx-conf.html>ququ大神</a>的博客配置的。</p><h4 id=安装依赖>安装依赖<a href=#安装依赖 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 安装开发工具</span>
</span></span><span class=line><span class=cl>sudo yum groupinstall -y <span class=s2>&#34;Development Tools&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 安装依赖</span>
</span></span><span class=line><span class=cl>sudo yum install -y git wget zlib zlib-devel pcre-devel lua-devel 
</span></span></code></pre></div><h4 id=获取组件>获取组件<a href=#获取组件 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><p>这部分主要是按照曲曲的配置来的，我就不细说。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl><span class=c1># 启用CT功能的nginx-ct</span>
</span></span><span class=line><span class=cl>wget -O nginx-ct.zip -c https://github.com/grahamedgecombe/nginx-ct/archive/v1.3.2.zip
</span></span><span class=line><span class=cl>unzip nginx-ct.zip
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Google的Brotli 压缩算法，减少流量</span>
</span></span><span class=line><span class=cl>git clone https://github.com/bagder/libbrotli
</span></span><span class=line><span class=cl><span class=nb>cd</span> libbrotli
</span></span><span class=line><span class=cl>./autogen.sh
</span></span><span class=line><span class=cl>./configure
</span></span><span class=line><span class=cl>make
</span></span><span class=line><span class=cl>sudo make install
</span></span><span class=line><span class=cl><span class=nb>cd</span>  ../
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取ngx-brotli源码</span>
</span></span><span class=line><span class=cl>git clone https://github.com/google/ngx_brotli.git
</span></span><span class=line><span class=cl><span class=nb>cd</span> ngx_brotli
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>git submodule update --init 
</span></span><span class=line><span class=cl><span class=nb>cd</span> ../
</span></span></code></pre></div><h4 id=openssl>OpenSSL<a href=#openssl class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><p>下载GitHub上最新的pre6版本即可。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget https://codeload.github.com/openssl/openssl/tar.gz/OpenSSL_1_1_1
</span></span><span class=line><span class=cl>tar -zxvf OpenSSL_1_1_1
</span></span><span class=line><span class=cl>mv openssl-OpenSSL_1_1_1 openssl
</span></span></code></pre></div><h4 id=编译安装nginx>编译安装Nginx<a href=#编译安装nginx class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><p>获取 Nginx 源码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>wget -c https://nginx.org/download/nginx-1.15.8.tar.gz
</span></span><span class=line><span class=cl>tar -zxvf nginx-1.15.8.tar.gz
</span></span><span class=line><span class=cl><span class=nb>cd</span> nginx-1.15.8/
</span></span></code></pre></div><p>编译以及安装</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./configure --add-module<span class=o>=</span>../ngx_brotli --add-module<span class=o>=</span>../nginx-ct-1.3.2 --with-openssl<span class=o>=</span>../openssl --with-http_v2_module --with-http_ssl_module --with-http_gzip_static_module
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>make
</span></span><span class=line><span class=cl>sudo make install
</span></span></code></pre></div><p>这一步完成，会给你一些提示，其中一些路径它会打印出来,configure时没指定就会使用默认的，如下。</p><blockquote><p>nginx path prefix: &ldquo;/usr/local/nginx&rdquo;</p><p>nginx binary file: &ldquo;/usr/local/nginx/sbin/nginx&rdquo;</p><p>nginx modules path: &ldquo;/usr/local/nginx/modules&rdquo;</p><p>nginx configuration prefix: &ldquo;/usr/local/nginx/conf&rdquo;</p><p>nginx configuration file: &ldquo;/usr/local/nginx/conf/nginx.conf&rdquo;</p><p>nginx pid file: &ldquo;/usr/local/nginx/logs/nginx.pid&rdquo;</p><p>nginx error log file: &ldquo;/usr/local/nginx/logs/error.log&rdquo;</p><p>nginx http access log file: &ldquo;/usr/local/nginx/logs/access.log&rdquo;</p><p>nginx http client request body temporary files: &ldquo;client_body_temp&rdquo;</p><p>nginx http proxy temporary files: &ldquo;proxy_temp&rdquo;</p><p>nginx http fastcgi temporary files: &ldquo;fastcgi_temp&rdquo;</p><p>nginx http uwsgi temporary files: &ldquo;uwsgi_temp&rdquo;</p><p>nginx http scgi temporary files: &ldquo;scgi_temp&rdquo;</p></blockquote><p>完成后可以将nginx加入到path中,或软链进去的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>ln /usr/local/nginx/sbin/nginx /usr/local/bin/nginx
</span></span></code></pre></div><p>查看一下是否安装正确：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ nginx -V
</span></span><span class=line><span class=cl>nginx version: nginx/1.15.8
</span></span><span class=line><span class=cl>built by gcc 4.8.5 <span class=m>20150623</span> <span class=o>(</span>Red Hat 4.8.5-36<span class=o>)</span> <span class=o>(</span>GCC<span class=o>)</span>
</span></span><span class=line><span class=cl>built with OpenSSL 1.1.1  <span class=m>11</span> Sep <span class=m>2018</span>
</span></span><span class=line><span class=cl>TLS SNI support enabled
</span></span><span class=line><span class=cl>configure arguments: --add-module<span class=o>=</span>../ngx_brotli --add-module<span class=o>=</span>../nginx-ct-1.3.2 --with-openssl<span class=o>=</span>../openssl --with-http_v2_module --with-http_ssl_module --with-http_gzip_static_module
</span></span></code></pre></div><p><code>OpenSSL 1.1.1</code>与<code>nginx/1.15.8</code> 看来已经OK了。</p><h4 id=管理脚本与自启>管理脚本与自启<a href=#管理脚本与自启 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>sudo vim /etc/init.d/nginx
</span></span></code></pre></div><p>输入以下内容：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl><span class=cp>#! /bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>### BEGIN INIT INFO</span>
</span></span><span class=line><span class=cl><span class=c1># Provides:          nginx</span>
</span></span><span class=line><span class=cl><span class=c1># Required-Start:    $all</span>
</span></span><span class=line><span class=cl><span class=c1># Required-Stop:     $all</span>
</span></span><span class=line><span class=cl><span class=c1># Default-Start:     2 3 4 5</span>
</span></span><span class=line><span class=cl><span class=c1># Default-Stop:      0 1 6</span>
</span></span><span class=line><span class=cl><span class=c1># Short-Description: starts the nginx web server</span>
</span></span><span class=line><span class=cl><span class=c1># Description:       starts nginx using start-stop-daemon</span>
</span></span><span class=line><span class=cl><span class=c1>### END INIT INFO</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>PATH</span><span class=o>=</span>/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
</span></span><span class=line><span class=cl><span class=nv>DAEMON</span><span class=o>=</span>/usr/local/nginx/sbin/nginx
</span></span><span class=line><span class=cl><span class=nv>NAME</span><span class=o>=</span>nginx
</span></span><span class=line><span class=cl><span class=nv>DESC</span><span class=o>=</span>nginx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>test</span> -x <span class=nv>$DAEMON</span> <span class=o>||</span> <span class=nb>exit</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Include nginx defaults if available</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -f /etc/default/nginx <span class=o>]</span> <span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  . /etc/default/nginx
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>set</span> -e
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>. /lib/lsb/init-functions
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> in
</span></span><span class=line><span class=cl>  start<span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> -n <span class=s2>&#34;Starting </span><span class=nv>$DESC</span><span class=s2>: &#34;</span>
</span></span><span class=line><span class=cl>    start-stop-daemon --start --quiet --pidfile /usr/local/nginx/logs/<span class=nv>$NAME</span>.pid <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        --exec <span class=nv>$DAEMON</span> -- <span class=nv>$DAEMON_OPTS</span> <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$NAME</span><span class=s2>.&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>;;</span>
</span></span><span class=line><span class=cl>  stop<span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> -n <span class=s2>&#34;Stopping </span><span class=nv>$DESC</span><span class=s2>: &#34;</span>
</span></span><span class=line><span class=cl>    start-stop-daemon --stop --quiet --pidfile /usr/local/nginx/logs/<span class=nv>$NAME</span>.pid <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        --exec <span class=nv>$DAEMON</span> <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$NAME</span><span class=s2>.&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>;;</span>
</span></span><span class=line><span class=cl>  restart<span class=p>|</span>force-reload<span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> -n <span class=s2>&#34;Restarting </span><span class=nv>$DESC</span><span class=s2>: &#34;</span>
</span></span><span class=line><span class=cl>    start-stop-daemon --stop --quiet --pidfile <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        /usr/local/nginx/logs/<span class=nv>$NAME</span>.pid --exec <span class=nv>$DAEMON</span> <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>    sleep <span class=m>1</span>
</span></span><span class=line><span class=cl>    start-stop-daemon --start --quiet --pidfile <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        /usr/local/nginx/logs/<span class=nv>$NAME</span>.pid --exec <span class=nv>$DAEMON</span> -- <span class=nv>$DAEMON_OPTS</span> <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$NAME</span><span class=s2>.&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>;;</span>
</span></span><span class=line><span class=cl>  reload<span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> -n <span class=s2>&#34;Reloading </span><span class=nv>$DESC</span><span class=s2> configuration: &#34;</span>
</span></span><span class=line><span class=cl>    start-stop-daemon --stop --signal HUP --quiet --pidfile /usr/local/nginx/logs/<span class=nv>$NAME</span>.pid <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        --exec <span class=nv>$DAEMON</span> <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$NAME</span><span class=s2>.&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>;;</span>
</span></span><span class=line><span class=cl>  status<span class=o>)</span>
</span></span><span class=line><span class=cl>    status_of_proc -p /usr/local/nginx/logs/<span class=nv>$NAME</span>.pid <span class=s2>&#34;</span><span class=nv>$DAEMON</span><span class=s2>&#34;</span> nginx <span class=o>&amp;&amp;</span> <span class=nb>exit</span> <span class=m>0</span> <span class=o>||</span> <span class=nb>exit</span> <span class=nv>$?</span>
</span></span><span class=line><span class=cl>    <span class=p>;;</span>
</span></span><span class=line><span class=cl>  *<span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>N</span><span class=o>=</span>/etc/init.d/<span class=nv>$NAME</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Usage: </span><span class=nv>$N</span><span class=s2> {start|stop|restart|reload|force-reload|status}&#34;</span> &gt;<span class=p>&amp;</span><span class=m>2</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=p>;;</span>
</span></span><span class=line><span class=cl><span class=k>esac</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>exit</span> <span class=m>0</span>
</span></span></code></pre></div><p>增加执行权限：</p><pre tabindex=0><code>sudo chmod a+x /etc/init.d/nginx
</code></pre><p>现在管理 Nginx 只需使用以下命令即可：</p><pre tabindex=0><code>sudo service nginx start|stop|restart|reload
</code></pre><p>如果启动出现错误<code>Starting nginx: /etc/init.d/nginx: line 32: start-stop-daemon: command not found</code>,那是<code>start-stop-daemon</code>工具没有安装，可按照以下方式安装。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>wget http://developer.axis.com/download/distribution/apps-sys-utils-start-stop-daemon-IR1_9_18-2.tar.gz
</span></span><span class=line><span class=cl>tar zxf apps-sys-utils-start-stop-daemon-IR1_9_18-2.tar.gz
</span></span><span class=line><span class=cl>mv apps/sys-utils/start-stop-daemon-IR1_9_18-2/ ./
</span></span><span class=line><span class=cl>rm -rf apps
</span></span><span class=line><span class=cl><span class=nb>cd</span> start-stop-daemon-IR1_9_18-2/
</span></span><span class=line><span class=cl>cc start-stop-daemon.c -o start-stop-daemon
</span></span><span class=line><span class=cl>cp start-stop-daemon /usr/local/bin/start-stop-daemon
</span></span><span class=line><span class=cl><span class=nb>cd</span> ../
</span></span></code></pre></div><p>开机自动启动 Nginx，执行以下命令：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>sudo chkconfig nginx on
</span></span></code></pre></div><h4 id=nginx配置>Nginx配置<a href=#nginx配置 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><p>最后贴以下我的nginx全局配置以及博客配置。</p><p>全局配置<code>vim /usr/local/nginx/conf/nginx.conf</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Nginx data-lang=Nginx><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>http</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>include</span>       <span class=s>mime.types</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>default_type</span>  <span class=s>application/octet-stream</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>#log_format  main  &#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>#                  &#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>#                  &#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>#access_log  logs/access.log  main;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=kn>charset</span> <span class=s>UTF-8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>sendfile</span>        <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>tcp_nopush</span>      <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>tcp_nodelay</span>     <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>#keepalive_timeout  0;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>keepalive_timeout</span>  <span class=mi>65</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>gzip</span>           <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>gzip_vary</span>      <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>gzip_comp_level</span>    <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>gzip_buffers</span>       <span class=mi>16</span> <span class=mi>8k</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>gzip_min_length</span>    <span class=mi>1000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>gzip_proxied</span>       <span class=s>any</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>gzip_disable</span>       <span class=s>&#34;msie6&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>gzip_http_version</span>  <span class=mi>1</span><span class=s>.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>gzip_types</span>         <span class=s>text/plain</span> <span class=s>text/css</span> <span class=s>application/json</span> <span class=s>application/x-javascript</span> <span class=s>text/xml</span> <span class=s>application/xml</span> <span class=s>application/xml+rss</span> <span class=s>text/javascript</span> <span class=s>application/javascript</span> <span class=s>image/svg+xml</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 如果编译时添加了 ngx_brotli 模块，需要增加 brotli 相关配置
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>brotli</span>             <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>brotli_comp_level</span>  <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>brotli_types</span>       <span class=s>text/plain</span> <span class=s>text/css</span> <span class=s>application/json</span> <span class=s>application/x-javascript</span> <span class=s>text/xml</span> <span class=s>application/xml</span> <span class=s>application/xml+rss</span> <span class=s>text/javascript</span> <span class=s>application/javascript</span> <span class=s>image/svg+xml</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>include</span>            <span class=s>/www/*/*.conf</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>博客配置 <code>vim /www/blog/nginx.conf</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Nginx data-lang=Nginx><span class=line><span class=cl><span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span>                       <span class=mi>443</span> <span class=s>ssl</span> <span class=s>default</span> <span class=s>http2</span> <span class=s>fastopen=3</span> <span class=s>reuseport</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>server_name</span>                  <span class=s>razeen.me</span> <span class=s>www.razeen.me</span> <span class=s>blog.netcj.com</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>server_tokens</span>                <span class=no>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>access_log</span>                   <span class=s>/www/blog/logdata/nginx.log</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># ip 黑名单
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>include</span>                      <span class=s>/www/blog/ip.blacklist</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 现在一般证书是内置的。letsencrypt 暂未
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># https://imququ.com/post/certificate-transparency.html#toc-2
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># ssl_ct                       on;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># ssl_ct_static_scts           /www/blog/scts/rsa/;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># ssl_ct_static_scts           /www/blog/scts/ecc/;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 中间证书 + 根证书
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># https://imququ.com/post/why-can-not-turn-on-ocsp-stapling.html
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>ssl_trusted_certificate</span>      <span class=s>/www/blog/ca_file.pem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 站点证书 + 中间证书，私钥
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>ssl_certificate</span>              <span class=s>/root/.acme.sh/netcj.com/fullchain.cer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_certificate_key</span>          <span class=s>/root/.acme.sh/netcj.com/netcj.com.key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_certificate</span>              <span class=s>/root/.acme.sh/netcj.com_ecc/fullchain.cer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_certificate_key</span>          <span class=s>/root/.acme.sh/netcj.com_ecc/netcj.com.key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># openssl dhparam -out dhparams.pem 2048
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># https://weakdh.org/sysadmin.html
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>ssl_dhparam</span>                  <span class=s>/www/blog/dhparams.pem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># openssl rand 48 &gt; session_ticket.key
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># 单机部署可以不指定 ssl_session_ticket_key
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># ssl_session_ticket_key     /www/blog/session_ticket.key;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1># https://github.com/cloudflare/sslconfig/blob/master/conf
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># ssl_ciphers               EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1># 如果启用了 RSA + ECDSA 双证书，Cipher Suite 可以参考以下配置：
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># ssl_ciphers                 EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+ECDSA+AES128:EECDH+aRSA+AES128:RSA+AES128:EECDH+ECDSA+AES256:EECDH+aRSA+AES256:RSA+AES256:EECDH+ECDSA+3DES:EECDH+aRSA+3DES:RSA+3DES:!MD5;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1># TLS 1.3
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>ssl_ciphers</span>                 <span class=s>TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+ECDSA+AES128:EECDH+aRSA+AES128:RSA+AES128:EECDH+ECDSA+AES256:EECDH+aRSA+AES256:RSA+AES256:EECDH+ECDSA+3DES:EECDH+aRSA+3DES:RSA+3DES:!MD5</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kn>ssl_prefer_server_ciphers</span>    <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_protocols</span>                <span class=s>TLSv1</span> <span class=s>TLSv1.1</span> <span class=s>TLSv1.2</span> <span class=s>TLSv1.3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_session_cache</span>            <span class=s>shared:SSL:50m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_session_timeout</span>          <span class=s>1d</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_session_tickets</span>          <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># ssl stapling
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>ssl_stapling</span>                 <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_stapling_verify</span>          <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>resolver</span>                     <span class=mi>114</span><span class=s>.114.114.114</span> <span class=mi>8</span><span class=s>.8.8.8</span> <span class=s>valid=300s</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>resolver_timeout</span>             <span class=s>10s</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>if</span> <span class=s>(</span><span class=nv>$request_method</span> <span class=s>!~</span> <span class=s>^(GET|HEAD|POST|OPTIONS)</span>$ <span class=s>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>return</span>                   <span class=mi>444</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>#if ($host != &#39;razeen.me&#39; ) {
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>#   rewrite                  ^/(.*)$  https://razeen.me/$1 permanent;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>#}
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1># webmaster 站点验证相关
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>location</span> <span class=p>~</span><span class=sr>*</span> <span class=s>(google4c90d18e696bdcf8\.html|BingSiteAuth\.xml)</span>$ <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>root</span>                     <span class=s>/www/blog/static</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>expires</span>                  <span class=s>1d</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>location</span> <span class=s>^~</span> <span class=s>/admin/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_http_version</span>       <span class=mi>1</span><span class=s>.1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kn>add_header</span>               <span class=s>Strict-Transport-Security</span> <span class=s>&#34;max-age=31536000</span><span class=p>;</span> <span class=kn>includeSubDomains</span><span class=p>;</span> <span class=kn>preload&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># deny 将完全不允许页面被嵌套，可能会导致一些异常。如果遇到这样的问题，建议改成 SAMEORIGIN
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1># https://imququ.com/post/web-security-and-response-header.html#toc-1
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kn>add_header</span>               <span class=s>X-Frame-Options</span> <span class=s>deny</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>add_header</span>               <span class=s>X-Powered-By</span> <span class=s>eiblog/1.3.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>add_header</span>               <span class=s>X-Content-Type-Options</span> <span class=s>nosniff</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span>         <span class=s>Connection</span>       <span class=s>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span>         <span class=s>Host</span>             <span class=s>razeen.me</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span>         <span class=s>X-Real_IP</span>        <span class=nv>$remote_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span>         <span class=s>X-Forwarded-For</span>  <span class=nv>$proxy_add_x_forwarded_for</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_pass</span>               <span class=s>http://127.0.0.1:9000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_http_version</span>       <span class=mi>1</span><span class=s>.1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kn>add_header</span>               <span class=s>Strict-Transport-Security</span> <span class=s>&#34;max-age=31536000</span><span class=p>;</span> <span class=kn>includeSubDomains</span><span class=p>;</span> <span class=kn>preload&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>add_header</span>               <span class=s>X-Frame-Options</span> <span class=s>deny</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>add_header</span>               <span class=s>X-Content-Type-Options</span> <span class=s>nosniff</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>add_header</span>               <span class=s>Content-Security-Policy</span> <span class=s>&#34;default-src</span> <span class=s>&#39;none&#39;</span><span class=p>;</span> <span class=kn>script-src</span> <span class=s>&#39;unsafe-inline&#39;</span> <span class=s>&#39;unsafe-eval&#39;</span> <span class=s>blob:</span> <span class=s>https:</span><span class=p>;</span> <span class=kn>img-src</span> <span class=s>data:</span> <span class=s>https:</span> <span class=s>https://st.razeen.cn</span><span class=p>;</span> <span class=kn>media-src</span> <span class=s>https://st.razeen.cn</span><span class=p>;</span> <span class=kn>style-src</span> <span class=s>&#39;unsafe-inline&#39;</span> <span class=s>https:</span><span class=p>;</span> <span class=kn>child-src</span> <span class=s>https:</span><span class=p>;</span> <span class=kn>connect-src</span> <span class=s>&#39;self&#39;</span> <span class=s>https://translate.googleapis.com</span><span class=p>;</span> <span class=kn>frame-src</span> <span class=s>https://disqus.com</span> <span class=s>https://www.slideshare.net&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 中间证书证书指纹
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1># https://imququ.com/post/http-public-key-pinning.html
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kn>add_header</span>               <span class=s>Public-Key-Pins</span> <span class=s>&#39;pin-sha256=&#34;YLh1dUR9y6Kja30RrAn7JKnbQG/uEtLMkBgFF2Fuihg=&#34;</span><span class=p>;</span> <span class=kn>pin-sha256=&#34;yz9Exfr7nuNjI2KbGJUzBjJ+jLLBlXm4jMjVcxT9jsw=&#34;</span><span class=p>;</span> <span class=kn>pin-sha256=&#34;3sWAZ33ibdUXCDLJsVsMf/yCP5WduqMI9lVcNo1vvd0=&#34;</span><span class=p>;</span>  <span class=kn>max-age=2592000</span><span class=p>;</span><span class=kn>&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kn>add_header</span>               <span class=s>Cache-Control</span> <span class=s>no-cache</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>add_header</span>               <span class=s>X-Via</span> <span class=s>AQ</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>add_header</span>               <span class=s>X-XSS-Protection</span> <span class=s>&#34;1</span><span class=p>;</span> <span class=kn>mode=block&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>add_header</span>               <span class=s>X-Powered-By</span> <span class=s>eiblog/1.3.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_ignore_headers</span>     <span class=s>Set-Cookie</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_hide_header</span>        <span class=s>Vary</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span>         <span class=s>Connection</span>       <span class=s>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span>         <span class=s>Host</span>             <span class=s>razeen.me</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span>         <span class=s>X-Real_IP</span>        <span class=nv>$remote_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span>         <span class=s>X-Forwarded-For</span>  <span class=nv>$proxy_add_x_forwarded_for</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_pass</span>               <span class=s>http://127.0.0.1:9000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>server_name</span>                  <span class=s>www.razeen.me</span> <span class=s>razeen.me</span> <span class=s>blog.netcj.com</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>server_tokens</span>                <span class=no>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>access_log</span>                   <span class=s>/dev/null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>if</span> <span class=s>(</span><span class=nv>$request_method</span> <span class=s>!~</span> <span class=s>^(GET|HEAD|POST|OPTIONS)</span>$ <span class=s>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>return</span>                   <span class=mi>444</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># letsencrypt file verify
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>location</span> <span class=s>^~</span> <span class=s>/.well-known/acme-challenge/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>alias</span>                    <span class=s>/www/blog/challenges/</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>try_files</span>                <span class=nv>$uri</span> <span class=p>=</span><span class=mi>404</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>rewrite</span>                  <span class=s>^/(.*)</span>$ <span class=s>https://razeen.me/</span><span class=nv>$1</span> <span class=s>permanent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=测试>测试<a href=#测试 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><p><a href="https://myssl.com/blog.netcj.com?domain=blog.netcj.com&status=q">MySSL.com</a>检测A+，整体配置过关。</p><p><img src=https://s.razeen.cn/images/2018/Jietu20180416-014629.png alt></p><p>再用工具测一下了.</p><p>工具：<a href=https://testssl.sh/>testssl</a></p><p>安装与测试：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone --depth <span class=m>1</span> https://github.com/drwetter/testssl.sh.git
</span></span><span class=line><span class=cl><span class=nb>cd</span> testssl.sh
</span></span><span class=line><span class=cl>./testssl.sh -p https://blog.netcj.com
</span></span></code></pre></div><p>结果：</p><p><img src=https://s.razeen.cn/images/2018/Jietu20180416-014706.png alt></p><p>嗯，到这里就我的博客就支持最新的TLS1.3拉~。</p><h3 id=参考>参考<a href=#参考 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><ul><li><a href=https://imququ.com/post/my-nginx-conf.html>本博客 Nginx 配置之完整篇</a></li><li><a href=https://www.bilimoe.com/draft-22/>TLS1.3 更新 Draft-26</a></li></ul></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://razeencheng.com/tags/tls1.3>tls1.3</a></span><span class=tag><a href=https://razeencheng.com/tags/nginx>nginx</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>1920 字</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2018-04-16 02:18 +0000</p></footer></article><aside id=toc class=show-toc><div class=toc-title>目录</div><nav id=TableOfContents><ul><li><ul><li><a href=#关于tls13>关于TLS1.3</a></li><li><a href=#编译nginx>编译Nginx</a></li><li><a href=#参考>参考</a></li></ul></li></ul></nav></aside><div class="post-nav thin"><a class=next-post href=https://razeencheng.com/posts/go-how-to-write-benchmark/><span class=post-nav-label><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>&nbsp;新</span><br><span>Go学习笔记(三) | 怎么写Go基准测试（性能测试）</span></a>
<a class=prev-post href=https://razeencheng.com/posts/strage-db-delete/><span class=post-nav-label>旧&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>一次诡异的数据库删除</span></a></div><div id=google-ads class=thin><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4450478767591566" crossorigin=anonymous></script>
<ins class=adsbygoogle style=display:block data-ad-client=ca-pub-4450478767591566 data-ad-slot=8164928618 data-ad-format=auto data-full-width-responsive=true></ins>
<script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div id=comments class=thin><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//razeen-me.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></main><footer id=site-footer class="section-inner thin"><p>&copy; 2017 - 2022 <a href=https://razeencheng.com>Razeen</a> &#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://razeencheng.com/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://s.razeen.cn/assets/js/mermaid.min.js></script>
<script>Array.from(document.getElementsByClassName("language-mermaid")).forEach(e=>{e.parentElement.outerHTML=`<div class="mermaid">${e.innerText}</div>`})</script><script src=https://razeencheng.com/js/main.min.4e6345981f1ff315bbb7afa61eacf413923b536e5a4d5b22f698d96b624d48c4.js integrity="sha256-TmNFmB8f8xW7t6+mHqz0E5I7U25aTVsi9pjZa2JNSMQ=" crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4BKH11NSEY"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4BKH11NSEY")</script></body></html>