<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="Go学习笔记（十）老项目迁移 go module 大型灾难记录"><meta itemprop=description content="最近在改造一个比较早期的一个项目，其中就涉及到用将原来 Vendor 管理依赖换成 Go Modules 来管理。 然而过程真是一波三折，在这里总结一下此次 Go Modules 改造中遇到的问题，以及解决方法。"><meta itemprop=datePublished content="2021-07-20T09:30:10+00:00"><meta itemprop=dateModified content="2021-07-20T09:30:10+00:00"><meta itemprop=wordCount content="1845"><meta itemprop=image content="https://razeencheng.com/android-chrome-192x192.png"><meta itemprop=keywords content="golang,go module,"><meta property="og:title" content="Go学习笔记（十）老项目迁移 go module 大型灾难记录"><meta property="og:description" content="最近在改造一个比较早期的一个项目，其中就涉及到用将原来 Vendor 管理依赖换成 Go Modules 来管理。 然而过程真是一波三折，在这里总结一下此次 Go Modules 改造中遇到的问题，以及解决方法。"><meta property="og:type" content="article"><meta property="og:url" content="https://razeencheng.com/posts/accidents-of-migrating-to-go-modules/"><meta property="og:image" content="https://razeencheng.com/android-chrome-192x192.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-07-20T09:30:10+00:00"><meta property="article:modified_time" content="2021-07-20T09:30:10+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://razeencheng.com/android-chrome-192x192.png"><meta name=twitter:title content="Go学习笔记（十）老项目迁移 go module 大型灾难记录"><meta name=twitter:description content="最近在改造一个比较早期的一个项目，其中就涉及到用将原来 Vendor 管理依赖换成 Go Modules 来管理。 然而过程真是一波三折，在这里总结一下此次 Go Modules 改造中遇到的问题，以及解决方法。"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon href=/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=mask-icon href=/safari-pinned-tab.svg><link rel=manifest crossorigin=use-credentials href=/site.webmanifest><link rel="shortcut icon" href=/favicon.ico><title>Go学习笔记（十）老项目迁移 go module 大型灾难记录</title><link rel=stylesheet href=https://razeencheng.com/css/style.min.a88782436067f84711b02510e9f09bd68bd49c25cd2e03624cd7320fa893b6ea.css integrity="sha256-qIeCQ2Bn+EcRsCUQ6fCb1ovUnCXNLgNiTNcyD6iTtuo=" crossorigin=anonymous></head><body id=page><header id=site-header><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://razeencheng.com>Razeen`s Blog</a></div><nav class="site-nav hide-in-mobile"><a href=https://razeencheng.com/posts/>文章</a>
<a href=https://razeencheng.com/tags/>标签</a>
<a href=https://razeencheng.com/categories/>分类</a>
<a href=https://razeencheng.com/about/>关于</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href=https://twitter.com/razeencheng target=_blank rel="noopener me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=https://github.com/razeencheng target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></span><button id=menu-btn class=hdr-btn title=菜单><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://razeencheng.com/posts/>文章</a></li><li><a href=https://razeencheng.com/tags/>标签</a></li><li><a href=https://razeencheng.com/categories/>分类</a></li><li><a href=https://razeencheng.com/about/>关于</a></li></ul></div><main class="site-main section-inner"><article class=thin><header class=post-header><div class=post-meta><span>Jul 20, 2021</span></div><h1>Go学习笔记（十）老项目迁移 go module 大型灾难记录</h1></header><div class=content><p>最近在改造一个比较早期的一个项目，其中就涉及到用将原来 <code>Vendor</code> 管理依赖换成 <code>Go Modules</code> 来管理。 然而过程真是一波三折，在这里总结一下此次 <code>Go Modules</code> 改造中遇到的问题，以及解决方法。</p><h3 id=背景>背景<a href=#背景 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><ul><li><p>go version：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ go version
</span></span><span class=line><span class=cl>go version go1.16.5 darwin/amd64
</span></span></code></pre></div></li><li><p>简化的 demo 如下, 很 “简单” 我们只要把 <code>hello world</code> 输出即可。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/coreos/etcd/pkg/transport&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/google/certificate-transparency-go/tls&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/qiniu/api.v7/auth/qbox&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;go.etcd.io/etcd/clientv3&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;google.golang.org/grpc&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;qiniupkg.com/x/log.v7&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>_</span> <span class=p>=</span> <span class=nx>transport</span><span class=p>.</span><span class=nx>TLSInfo</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>_</span> <span class=p>=</span> <span class=nx>clientv3</span><span class=p>.</span><span class=nx>WatchResponse</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>_</span><span class=p>,</span> <span class=nx>_</span> <span class=p>=</span> <span class=nx>clientv3</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>clientv3</span><span class=p>.</span><span class=nx>Config</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>_</span> <span class=p>=</span> <span class=nx>qbox</span><span class=p>.</span><span class=nf>NewMac</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>_</span> <span class=p>=</span> <span class=nx>tls</span><span class=p>.</span><span class=nx>DigitallySigned</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>_</span> <span class=p>=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nx>ClientConn</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;hello world&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></li></ul><h3 id=实战>实战<a href=#实战 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>直接初始化，并 tidy 一下。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ go mod init demo-go/gomod
</span></span><span class=line><span class=cl>go: creating new go.mod: module demo-go/gomod
</span></span><span class=line><span class=cl>go: to add module requirements and sums:
</span></span><span class=line><span class=cl>        go mod tidy
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>$ go mod tidy
</span></span><span class=line><span class=cl>go: finding module <span class=k>for</span> ...
</span></span><span class=line><span class=cl>demo-go/gomod imports
</span></span><span class=line><span class=cl>        qiniupkg.com/x/log.v7: module qiniupkg.com/x@latest found <span class=o>(</span>v1.11.5<span class=o>)</span>, but does not contain package qiniupkg.com/x/log.v7
</span></span><span class=line><span class=cl>demo-go/gomod imports
</span></span><span class=line><span class=cl>        github.com/qiniu/api.v7/auth/qbox imports
</span></span><span class=line><span class=cl>        github.com/qiniu/x/bytes.v7/seekable: module github.com/qiniu/x@latest found <span class=o>(</span>v1.11.5<span class=o>)</span>, but does not contain package github.com/qiniu/x/bytes.v7/seekable
</span></span><span class=line><span class=cl>demo-go/gomod imports
</span></span><span class=line><span class=cl>        go.etcd.io/etcd/clientv3 imports
</span></span><span class=line><span class=cl>        github.com/coreos/etcd/Godeps/_workspace/src/golang.org/x/net/context: package github.com/coreos/etcd/Godeps/_workspace/src/golang.org/x/net/context provided by github.com/coreos/etcd at latest version v2.3.8+incompatible but not at required version v3.3.10+incompatible
</span></span><span class=line><span class=cl>demo-go/gomod imports
</span></span><span class=line><span class=cl>        go.etcd.io/etcd/clientv3 imports
</span></span><span class=line><span class=cl>        github.com/coreos/etcd/Godeps/_workspace/src/google.golang.org/grpc: package github.com/coreos/etcd/Godeps/_workspace/src/google.golang.org/grpc provided by github.com/coreos/etcd at latest version v2.3.8+incompatible but not at required version v3.3.10+incompatible
</span></span><span class=line><span class=cl>demo-go/gomod imports
</span></span><span class=line><span class=cl>        go.etcd.io/etcd/clientv3 imports
</span></span><span class=line><span class=cl>        github.com/coreos/etcd/Godeps/_workspace/src/google.golang.org/grpc/credentials: package github.com/coreos/etcd/Godeps/_workspace/src/google.golang.org/grpc/credentials provided by github.com/coreos/etcd at latest version v2.3.8+incompatible but not at required version v3.3.10+incompatible
</span></span><span class=line><span class=cl>demo-go/gomod imports
</span></span><span class=line><span class=cl>        go.etcd.io/etcd/clientv3 imports
</span></span><span class=line><span class=cl>        github.com/coreos/etcd/storage/storagepb: package github.com/coreos/etcd/storage/storagepb provided by github.com/coreos/etcd at latest version v2.3.8+incompatible but not at required version v3.3.10+incompatible
</span></span></code></pre></div><p>好家伙，报错了。我们先看到前两行</p><ol><li><code>qiniupkg.com/x@latest</code> 中没有 <code>qiniupkg.com/x/log.v7</code>；</li><li><code>github.com/qiniu/x@latest</code> 中没有 <code>github.com/qiniu/x/bytes.v7/seekable</code>；</li></ol><p>这看起来应该是一个问题， <code>qiniupkg.com/x</code> 和<code>github.com/qiniu/x</code> 应该是同一个包，不同镜像。于是我到 Github 看一下 <code>@lastet</code> 版本的代码，确实没有<code>bytes.v7</code> 包了。人肉查找，最后在 <code>v1.7.8</code> 版本，我们找到了 <code>bytes.v7</code> 包。</p><p>于是，我们可以指定一下版本。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go mod edit -replace qiniupkg.com/x<span class=o>=</span>qiniupkg.com/x@v1.7.8
</span></span><span class=line><span class=cl>go mod edit -replace github.com/qiniu/x<span class=o>=</span>github.com/qiniu/x@v1.7.8
</span></span></code></pre></div><p>继续往下看，接下来的几个问题是一类的，都是<code>etcd</code>导致的。</p><p>意思是 <code>go.etcd.io/etcd/clientv3</code> 导入了 <code>github.com/coreos/etcd/Godeps/_workspace/src/golang.org/x/net/context</code>, 同时 <code>github.com/coreos/etcd@v2.3.8</code> 中 提供了 <code>github.com/coreos/etcd/Godeps/_workspace/src/golang.org/x/net/context</code> 。 但是，我们这里需要 <code>github.com/coreos/etcd@v3.3.10</code>, 而该版本并不提供 <code>github.com/coreos/etcd/Godeps/_workspace/src/golang.org/x/net/context</code> 。</p><p>我们直接更新 etcd 到的 <code>v3.3.10</code> 试试。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go mod edit -replace go.etcd.io/etcd<span class=o>=</span>go.etcd.io/etcd@v3.3.20+incompatible
</span></span></code></pre></div><p>我们再 <code>go mod tidy</code> 下。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ go mod tidy
</span></span><span class=line><span class=cl>go: demo-go/gomod imports
</span></span><span class=line><span class=cl>        go.etcd.io/etcd/clientv3 tested by
</span></span><span class=line><span class=cl>        go.etcd.io/etcd/clientv3.test imports
</span></span><span class=line><span class=cl>        github.com/coreos/etcd/auth imports
</span></span><span class=line><span class=cl>        github.com/coreos/etcd/mvcc/backend imports
</span></span><span class=line><span class=cl>        github.com/coreos/bbolt: github.com/coreos/bbolt@v1.3.6: parsing go.mod:
</span></span><span class=line><span class=cl>        module declares its path as: go.etcd.io/bbolt
</span></span><span class=line><span class=cl>                but was required as: github.com/coreos/bbolt
</span></span></code></pre></div><p>这个错误和鸟窝这篇 <a href=https://colobu.com/2020/04/09/accidents-of-etcd-and-go-module/>Etcd使用go module的灾难</a>一致，<code>go.etcd.io/bbolt</code> 和 <code>github.com/coreos/bbolt</code> 包名不一致，我们替换一下。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go mod edit -replace github.com/coreos/bbolt@v1.3.6<span class=o>=</span>go.etcd.io/bbolt@v1.3.6
</span></span></code></pre></div><p>继续，<code>go mod tidy</code> 一下。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ go mod tidy
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>demo-go/gomod imports
</span></span><span class=line><span class=cl>        go.etcd.io/etcd/clientv3 imports
</span></span><span class=line><span class=cl>        github.com/coreos/etcd/clientv3/balancer: module github.com/coreos/etcd@latest found <span class=o>(</span>v2.3.8+incompatible<span class=o>)</span>, but does not contain package github.com/coreos/etcd/clientv3/balancer
</span></span><span class=line><span class=cl>demo-go/gomod imports
</span></span><span class=line><span class=cl>        go.etcd.io/etcd/clientv3 imports
</span></span><span class=line><span class=cl>        github.com/coreos/etcd/clientv3/balancer/picker: module github.com/coreos/etcd@latest found <span class=o>(</span>v2.3.8+incompatible<span class=o>)</span>, but does not contain package github.com/coreos/etcd/clientv3/balancer/picker
</span></span><span class=line><span class=cl>demo-go/gomod imports
</span></span><span class=line><span class=cl>        go.etcd.io/etcd/clientv3 imports
</span></span><span class=line><span class=cl>        github.com/coreos/etcd/clientv3/balancer/resolver/endpoint: module github.com/coreos/etcd@latest found <span class=o>(</span>v2.3.8+incompatible<span class=o>)</span>, but does not contain package github.com/coreos/etcd/clientv3/balancer/resolver/endpoint
</span></span><span class=line><span class=cl>demo-go/gomod imports
</span></span><span class=line><span class=cl>        go.etcd.io/etcd/clientv3 imports
</span></span><span class=line><span class=cl>        github.com/coreos/etcd/clientv3/credentials: module github.com/coreos/etcd@latest found <span class=o>(</span>v2.3.8+incompatible<span class=o>)</span>, but does not contain package github.com/coreos/etcd/clientv3/credentials
</span></span><span class=line><span class=cl>demo-go/gomod imports
</span></span><span class=line><span class=cl>        go.etcd.io/etcd/clientv3 tested by
</span></span><span class=line><span class=cl>        go.etcd.io/etcd/clientv3.test imports
</span></span><span class=line><span class=cl>        github.com/coreos/etcd/integration imports
</span></span><span class=line><span class=cl>        github.com/coreos/etcd/proxy/grpcproxy imports
</span></span><span class=line><span class=cl>        google.golang.org/grpc/naming: module google.golang.org/grpc@latest found <span class=o>(</span>v1.39.0<span class=o>)</span>, but does not contain package google.golang.org/grpc/naming
</span></span></code></pre></div><p>好家伙，又是<code>etcd</code>。 仔细一看，我们导入了<code>github.com/coreos/etcd</code> 和 <code>go.etcd.io/etcd</code> 两个版本<code>etcd</code>, 我们前面只替换了一个。现在我们把另外一个也替换了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go mod edit -replace github.com/coreos/etcd<span class=o>=</span>github.com/coreos/etcd@v3.3.20+incompatible
</span></span></code></pre></div><p>再<code>go mod tidy</code>下，这个错误没有了，但还有个<code>grpc</code>的错误，继续找原因。原来是<code> google.golang.org/grpc</code> <code>v1.39.0</code> 版本没有<code> google.golang.org/grpc/naming</code> 包。 上 Github 仓库， 找了一下历史版本，<code>v1.29.1</code>上是有这个包的，我们继续替换。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go mod edit -replace google.golang.org/grpc<span class=o>=</span>google.golang.org/grpc@v1.29.1
</span></span></code></pre></div><p>这下，终于，<code>go mod tidy</code>通过了，可以开心的输出<code>hello world</code> 了。</p><p>然而，</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ go run main.go
</span></span><span class=line><span class=cl><span class=c1># github.com/coreos/etcd/clientv3/balancer/resolver/endpoint</span>
</span></span><span class=line><span class=cl>../../../go/pkg/mod/github.com/coreos/etcd@v3.3.20+incompatible/clientv3/balancer/resolver/endpoint/endpoint.go:114:78: undefined: resolver.BuildOption
</span></span><span class=line><span class=cl>../../../go/pkg/mod/github.com/coreos/etcd@v3.3.20+incompatible/clientv3/balancer/resolver/endpoint/endpoint.go:182:31: undefined: resolver.ResolveNowOption
</span></span><span class=line><span class=cl><span class=c1># github.com/coreos/etcd/clientv3/balancer/picker</span>
</span></span><span class=line><span class=cl>../../../go/pkg/mod/github.com/coreos/etcd@v3.3.20+incompatible/clientv3/balancer/picker/err.go:37:44: undefined: balancer.PickOptions
</span></span><span class=line><span class=cl>../../../go/pkg/mod/github.com/coreos/etcd@v3.3.20+incompatible/clientv3/balancer/picker/roundrobin_balanced.go:55:54: undefined: balancer.PickOptions
</span></span></code></pre></div><p>意不意外，惊不惊喜！!</p><p>原来<code>etcd</code>包依赖了<code>grpc</code>的<code>resolver</code>包，但我导入的<code>v1.29.1</code>版本的<code>grpc</code>是没有这个包的。到 <code>grpc</code><a href=https://github.com/grpc/grpc-go/blob/v1.26.0/resolver/resolver.go>仓库</a> 挨个版本看了一下，确实只有<code>v1.26.0</code>版本才声明了<code>type BuildOption</code> 。于是，我们再次使用替换大法。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go mod edit -replace google.golang.org/grpc<span class=o>=</span>google.golang.org/grpc@v1.26.0
</span></span></code></pre></div><p>再次<code>tidy</code>, 运行！ 终于，看到了久违的<code>hello world!</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ go run main.go
</span></span><span class=line><span class=cl>2021/07/20 12:27:09.642431 <span class=o>[</span>INFO<span class=o>]</span> /Users/razeen/wspace/github/demo-go/gomod/main.go:26: hello world
</span></span></code></pre></div><h3 id=总结>总结<a href=#总结 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><h4 id=项目规范>项目规范<a href=#项目规范 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><p>现在我们回过头看下这个 demo 项目，其实很有问题。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>	<span class=s>&#34;github.com/coreos/etcd/pkg/transport&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/google/certificate-transparency-go/tls&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/qiniu/api.v7/auth/qbox&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;go.etcd.io/etcd/clientv3&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;google.golang.org/grpc&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;qiniupkg.com/x/log.v7&#34;</span>
</span></span></code></pre></div><p><code>etcd</code> 和 <code>qiniupkg</code>的包完全可以统一，只导入一种！而且，后来我们发现<code>log.v7</code>这包也是意外导入的&mldr;.</p><p>这也是在改造我们一些老的项目时遇到的问题，以前用<code>vendor</code> <code>go get</code> 没有注意到这些问题，这是需要提前规范的。</p><h4 id=看懂-gomod>看懂 <code>go.mod</code><a href=#看懂-gomod class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><p>我们来简单看一下，经历各种坎坷后，得出的<code>go.mod</code> 文件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>module</span> <span class=nx>demo</span><span class=o>-</span><span class=k>go</span><span class=o>/</span><span class=nx>gomod</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>go</span> <span class=mf>1.16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>replace</span> <span class=nx>qiniupkg</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=nx>x</span> <span class=p>=&gt;</span> <span class=nx>qiniupkg</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=nx>x</span> <span class=nx>v1</span><span class=mf>.7.8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>replace</span> <span class=nx>github</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=nx>qiniu</span><span class=o>/</span><span class=nx>x</span> <span class=p>=&gt;</span> <span class=nx>github</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=nx>qiniu</span><span class=o>/</span><span class=nx>x</span> <span class=nx>v1</span><span class=mf>.7.8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>replace</span> <span class=k>go</span><span class=p>.</span><span class=nx>etcd</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>etcd</span> <span class=p>=&gt;</span> <span class=k>go</span><span class=p>.</span><span class=nx>etcd</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>etcd</span> <span class=nx>v3</span><span class=mf>.3.20</span><span class=o>+</span><span class=nx>incompatible</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>replace</span> <span class=nx>github</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=nx>coreos</span><span class=o>/</span><span class=nx>bbolt</span> <span class=nx>v1</span><span class=mf>.3.6</span> <span class=p>=&gt;</span> <span class=k>go</span><span class=p>.</span><span class=nx>etcd</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>bbolt</span> <span class=nx>v1</span><span class=mf>.3.6</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>replace</span> <span class=nx>github</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=nx>coreos</span><span class=o>/</span><span class=nx>etcd</span> <span class=p>=&gt;</span> <span class=nx>github</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=nx>coreos</span><span class=o>/</span><span class=nx>etcd</span> <span class=nx>v3</span><span class=mf>.3.20</span><span class=o>+</span><span class=nx>incompatible</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>replace</span> <span class=nx>google</span><span class=p>.</span><span class=nx>golang</span><span class=p>.</span><span class=nx>org</span><span class=o>/</span><span class=nx>grpc</span> <span class=p>=&gt;</span> <span class=nx>google</span><span class=p>.</span><span class=nx>golang</span><span class=p>.</span><span class=nx>org</span><span class=o>/</span><span class=nx>grpc</span> <span class=nx>v1</span><span class=mf>.26.0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>require</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>github</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=nx>coreos</span><span class=o>/</span><span class=nx>bbolt</span> <span class=nx>v1</span><span class=mf>.3.6</span> <span class=c1>// indirect
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>github</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=nx>coreos</span><span class=o>/</span><span class=nx>etcd</span> <span class=nx>v3</span><span class=mf>.3.10</span><span class=o>+</span><span class=nx>incompatible</span>
</span></span><span class=line><span class=cl>	<span class=nx>github</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=nx>dgrijalva</span><span class=o>/</span><span class=nx>jwt</span><span class=o>-</span><span class=k>go</span> <span class=nx>v3</span><span class=mf>.2.0</span><span class=o>+</span><span class=nx>incompatible</span> <span class=c1>// indirect
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>github</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=nx>google</span><span class=o>/</span><span class=nx>certificate</span><span class=o>-</span><span class=nx>transparency</span><span class=o>-</span><span class=k>go</span> <span class=nx>v1</span><span class=mf>.1.1</span>
</span></span><span class=line><span class=cl>	<span class=nx>github</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=nx>grpc</span><span class=o>-</span><span class=nx>ecosystem</span><span class=o>/</span><span class=k>go</span><span class=o>-</span><span class=nx>grpc</span><span class=o>-</span><span class=nx>prometheus</span> <span class=nx>v1</span><span class=mf>.2.0</span> <span class=c1>// indirect
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>github</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=nx>qiniu</span><span class=o>/</span><span class=nx>api</span><span class=p>.</span><span class=nx>v7</span> <span class=nx>v7</span><span class=mf>.2.5</span><span class=o>+</span><span class=nx>incompatible</span>
</span></span><span class=line><span class=cl>	<span class=nx>github</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=nx>qiniu</span><span class=o>/</span><span class=nx>x</span> <span class=nx>v0</span><span class=mf>.0.0</span><span class=o>-</span><span class=mo>00010101000000</span><span class=o>-</span><span class=mo>000000000000</span> <span class=c1>// indirect
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>github</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=nx>soheilhy</span><span class=o>/</span><span class=nx>cmux</span> <span class=nx>v0</span><span class=mf>.1.5</span> <span class=c1>// indirect
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>github</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=nx>xiang90</span><span class=o>/</span><span class=nx>probing</span> <span class=nx>v0</span><span class=mf>.0.0</span><span class=o>-</span><span class=mi>20190116061207</span><span class=o>-</span><span class=mi>43</span><span class=nx>a291ad63a2</span> <span class=c1>// indirect
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>go</span><span class=p>.</span><span class=nx>etcd</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>etcd</span> <span class=nx>v0</span><span class=mf>.0.0</span><span class=o>-</span><span class=mi>20200513171258</span><span class=o>-</span><span class=nx>e048e166ab9c</span>
</span></span><span class=line><span class=cl>	<span class=nx>google</span><span class=p>.</span><span class=nx>golang</span><span class=p>.</span><span class=nx>org</span><span class=o>/</span><span class=nx>grpc</span> <span class=nx>v1</span><span class=mf>.29.1</span>
</span></span><span class=line><span class=cl>	<span class=nx>qiniupkg</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=nx>x</span> <span class=nx>v0</span><span class=mf>.0.0</span><span class=o>-</span><span class=mo>00010101000000</span><span class=o>-</span><span class=mo>000000000000</span>
</span></span><span class=line><span class=cl>	<span class=nx>sigs</span><span class=p>.</span><span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>yaml</span> <span class=nx>v1</span><span class=mf>.2.0</span> <span class=c1>// indirect
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>)</span>
</span></span></code></pre></div><p>我们先看一个常见的这几个<a href=https://golang.org/ref/mod#go-mod-file-module>指令</a>，</p><ul><li><code>module</code> 定义主模块的路径；</li><li><code>go</code> 编写该<code>mod</code>文件时的go版本；</li><li><code>require</code> 声明给定模块依赖项的最低要求版本;</li><li><code>replace</code> 手动指定的依赖模块 (可以替换全部的版本、指定的版本、本地的版本等等 )；</li></ul><p>还有就是 <code>v3.3.20+incompatible</code> 后面的 <code>+incompatible</code> , 这是指兼容的版本，指依赖库的版本是<code>v2</code> 或以上，但<code>go.mod</code>和 依赖库路径 没有按照官方指定的方式命名，会加上这个。</p><p><code>v0.0.0-00010101000000-000000000000</code> 这是一个伪版本，在和 不兼容 module 或 标记的版本不可用的时候，回打上这个伪版本。</p><p><code>// indirect</code> 这指明这些不是我们直接引用的依赖。</p><p>除此之外，以下指令也可了解一下。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看当前模块以及所有的依赖模块</span>
</span></span><span class=line><span class=cl>go list -m all
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看某个模块的以及打标签的版本</span>
</span></span><span class=line><span class=cl>go list -m -versions go.etcd.io/etcd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 升级特定的包</span>
</span></span><span class=line><span class=cl>go get xx@version 升级特定的包
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 了解为什么需要模块</span>
</span></span><span class=line><span class=cl>go mod why -m all  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 为什么需要指定（google.golang.org/grpc）的模块</span>
</span></span><span class=line><span class=cl>go mod why -m google.golang.org/grpc
</span></span></code></pre></div><p>更多可以细读<a href=https://golang.org/ref/mod#incompatible-versions>官方文档</a>，感谢阅读。</p><h3 id=参考>参考<a href=#参考 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><ul><li><a href=https://blog.golang.org/using-go-modules>Using Go Modules</a></li><li><a href=https://research.swtch.com/vgo-mvs>Minimal Version Selection</a></li><li><a href=https://colobu.com/2018/08/27/learn-go-module/>跳出Go module的泥潭</a></li><li><a href=https://colobu.com/2020/04/09/accidents-of-etcd-and-go-module/>Etcd使用go module的灾难</a></li><li><a href=https://duyanghao.github.io/golang-module/>浅谈Go Modules原理</a></li></ul></div><div class="related-posts thin"><h2>相关推荐</h2><ul><li><a href=/posts/start-use-ubuntu-and-win/>折腾 Ubuntu 20.04 LTS 开发环境</a></li><li><a href=/posts/go-timers-life-cycle/>Go学习笔记（九） 计时器的生命周期[译]</a></li><li><a href=/posts/golang-and-git-commit-message-pre-commit/>利用 git hook 规范你的代码与 commit message</a></li><li><a href=/posts/golang-and-restful-api/>Golang 中的 RESTful API 最佳实践</a></li><li><a href=/posts/simple-use-go-exec-command/>Go学习笔记(八) | 使用 os/exec 执行命令</a></li></ul></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://razeencheng.com/tags/golang>golang</a></span><span class=tag><a href=https://razeencheng.com/tags/go-module>go module</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>1845 字</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2021-07-20 09:30 +0000</p></footer></article><aside id=toc class=show-toc><div class=toc-title>目录</div><nav id=TableOfContents><ul><li><ul><li><a href=#背景>背景</a></li><li><a href=#实战>实战</a></li><li><a href=#总结>总结</a></li><li><a href=#参考>参考</a></li></ul></li></ul></nav></aside><div class="post-nav thin"><a class=next-post href=https://razeencheng.com/posts/homelib-003-network-topology-and-hardware/><span class=post-nav-label><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>&nbsp;新</span><br><span>Homelib (3)： 整体网络与基础硬件介绍</span></a>
<a class=prev-post href=https://razeencheng.com/posts/shanghai-settltment-record/><span class=post-nav-label>旧&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>2021 上海人才引进落户全程记录</span></a></div><div id=google-ads class=thin><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4450478767591566" crossorigin=anonymous></script>
<ins class=adsbygoogle style=display:block data-ad-client=ca-pub-4450478767591566 data-ad-slot=8164928618 data-ad-format=auto data-full-width-responsive=true></ins>
<script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div id=comments class=thin><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//razeen-me.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></main><footer id=site-footer class="section-inner thin"><p>&copy; 2017 - 2022 <a href=https://razeencheng.com>Razeen</a> &#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://razeencheng.com/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://s.razeen.cn/assets/js/mermaid.min.js></script>
<script>Array.from(document.getElementsByClassName("language-mermaid")).forEach(e=>{e.parentElement.outerHTML=`<div class="mermaid">${e.innerText}</div>`})</script><script src=https://razeencheng.com/js/main.min.4e6345981f1ff315bbb7afa61eacf413923b536e5a4d5b22f698d96b624d48c4.js integrity="sha256-TmNFmB8f8xW7t6+mHqz0E5I7U25aTVsi9pjZa2JNSMQ=" crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4BKH11NSEY"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4BKH11NSEY")</script></body></html>